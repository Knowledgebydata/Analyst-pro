<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0d6efd">
    <title>ZorgAnalyst Pro Mobile</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #0d6efd;
            --primary-dark: #0a58ca;
            --secondary: #6c757d;
            --success: #198754;
            --danger: #dc3545;
            --warning: #ffc107;
            --light: #f8f9fa;
            --dark: #212529;
            --white: #ffffff;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --radius: 12px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--light);
            color: var(--dark);
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }
        
        .header h1 {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .header .subtitle {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 4px;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* GPS Indicator */
        .gps-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.7rem;
            padding: 4px 10px;
            border-radius: 20px;
            background: rgba(255,255,255,0.2);
            white-space: nowrap;
        }
        
        .gps-indicator.active {
            background: rgba(25, 135, 84, 0.3);
        }
        
        .gps-indicator.error {
            background: rgba(220, 53, 69, 0.3);
        }
        
        .gps-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--warning);
        }
        
        .gps-indicator.active .gps-dot {
            background: var(--success);
            animation: pulse 1.5s infinite;
        }
        
        .gps-indicator.error .gps-dot {
            background: var(--danger);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        /* Main Container */
        .container {
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        /* Cards */
        .card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
        }
        
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title i {
            color: var(--primary);
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--secondary);
        }
        
        .form-group label.required::after {
            content: ' *';
            color: var(--danger);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15);
        }
        
        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%236c757d' viewBox='0 0 16 16'%3E%3Cpath d='M8 10.5l-5-5h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 35px;
        }
        
        textarea.form-control {
            min-height: 150px;
            resize: vertical;
            line-height: 1.5;
        }
        
        textarea.form-control.speech-active {
            border-color: var(--danger);
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.15);
        }
        
        /* Row Layout */
        .form-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
        }
        
        /* Autocomplete */
        .autocomplete-container {
            position: relative;
        }
        
        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 2px solid var(--primary);
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 50;
            display: none;
        }
        
        .autocomplete-list.show {
            display: block;
        }
        
        .autocomplete-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .autocomplete-item:hover,
        .autocomplete-item.active {
            background: var(--light);
        }
        
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        
        /* Speech Button */
        .speech-container {
            position: relative;
        }
        
        .speech-btn {
            position: absolute;
            right: 10px;
            top: 10px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: var(--primary);
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(13, 110, 253, 0.3);
        }
        
        .speech-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }
        
        .speech-btn.recording {
            background: var(--danger);
            animation: pulse-record 1s infinite;
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4);
        }
        
        @keyframes pulse-record {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.6); }
            70% { box-shadow: 0 0 0 20px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
        
        .speech-status {
            font-size: 0.8rem;
            color: var(--secondary);
            margin-top: 8px;
            min-height: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .speech-status.recording {
            color: var(--danger);
            font-weight: 500;
        }
        
        .speech-status .audio-bars {
            display: none;
            gap: 2px;
            height: 16px;
            align-items: flex-end;
        }
        
        .speech-status.recording .audio-bars {
            display: flex;
        }
        
        .speech-status .audio-bar {
            width: 3px;
            background: var(--danger);
            border-radius: 2px;
            animation: audioBar 0.5s ease-in-out infinite;
        }
        
        .speech-status .audio-bar:nth-child(1) { animation-delay: 0s; height: 8px; }
        .speech-status .audio-bar:nth-child(2) { animation-delay: 0.1s; height: 12px; }
        .speech-status .audio-bar:nth-child(3) { animation-delay: 0.2s; height: 6px; }
        .speech-status .audio-bar:nth-child(4) { animation-delay: 0.3s; height: 14px; }
        .speech-status .audio-bar:nth-child(5) { animation-delay: 0.15s; height: 10px; }
        
        @keyframes audioBar {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.5); }
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #157347;
        }
        
        .btn-secondary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
        }
        
        /* Tags/Chips for bedrijven */
        .chips-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--light);
            border: 1px solid #dee2e6;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .chip.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .chip-remove {
            cursor: pointer;
            opacity: 0.7;
        }
        
        .chip-remove:hover {
            opacity: 1;
        }
        
        /* GPS Info Box */
        .gps-info {
            background: linear-gradient(135deg, #e8f4fd, #d1e7fd);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.85rem;
        }
        
        .gps-info.success {
            background: linear-gradient(135deg, #d1e7dd, #badbcc);
        }
        
        .gps-info.error {
            background: linear-gradient(135deg, #f8d7da, #f5c2c7);
        }
        
        .gps-coords {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            margin-top: 5px;
        }
        
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px;
            border-radius: var(--radius);
            text-align: center;
        }
        
        .stat-card.secondary {
            background: linear-gradient(135deg, var(--secondary), #5a6268);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        /* Melding List */
        .melding-item {
            background: var(--white);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.08);
            border-left: 4px solid var(--primary);
        }
        
        .melding-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .melding-type {
            font-size: 0.75rem;
            background: var(--light);
            padding: 3px 8px;
            border-radius: 4px;
            color: var(--secondary);
        }
        
        .melding-date {
            font-size: 0.75rem;
            color: var(--secondary);
        }
        
        .melding-bedrijven {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .melding-adres {
            font-size: 0.85rem;
            color: var(--secondary);
            margin-bottom: 8px;
        }
        
        .melding-omschrijving {
            font-size: 0.9rem;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .melding-item.expanded .melding-omschrijving {
            display: block;
            -webkit-line-clamp: unset;
        }
        
        .melding-item.expanded .melding-details {
            display: block !important;
        }
        
        .melding-item.expanded .melding-expand-hint {
            display: none;
        }
        
        .melding-item.expanded .fa-chevron-down {
            transform: rotate(180deg);
        }
        
        .melding-expand-hint {
            transition: opacity 0.2s;
        }
        
        /* Nieuwe melding card styling */
        .melding-card {
            background: var(--white);
            border-radius: 10px;
            margin-bottom: 12px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.08);
            border-left: 4px solid var(--primary);
            overflow: hidden;
        }
        
        .melding-card.expanded {
            border-left-color: var(--success);
        }
        
        .melding-card-header {
            padding: 15px;
            cursor: pointer;
        }
        
        .melding-card-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .melding-bedrijf {
            margin-bottom: 5px;
            color: var(--dark);
        }
        
        .melding-preview {
            font-size: 0.9rem;
            color: var(--secondary);
            line-height: 1.4;
            margin-bottom: 8px;
        }
        
        .melding-toggle {
            text-align: center;
            color: var(--primary);
            font-size: 0.8rem;
            padding-top: 5px;
            border-top: 1px dashed #eee;
        }
        
        .melding-card-body {
            background: #f8f9fa;
            padding: 15px;
            border-top: 1px solid #eee;
        }
        
        .melding-details-inner p {
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .melding-full-text {
            white-space: pre-wrap;
            background: var(--white);
            padding: 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-top: 8px;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            color: var(--secondary);
            text-decoration: none;
            font-size: 0.7rem;
            cursor: pointer;
            transition: color 0.2s;
            border: none;
            background: none;
        }
        
        .nav-item i {
            font-size: 1.3rem;
        }
        
        .nav-item.active {
            color: var(--primary);
        }
        
        /* Screens */
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        /* PIN Screen */
        .pin-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            z-index: 200;
            color: white;
        }
        
        .pin-screen.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .pin-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .pin-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 30px;
        }
        
        .pin-dots {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .pin-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
            transition: all 0.2s;
        }
        
        .pin-dot.filled {
            background: white;
        }
        
        .pin-keypad {
            display: grid;
            grid-template-columns: repeat(3, 70px);
            gap: 15px;
        }
        
        .pin-key {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pin-key:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .pin-key:active {
            transform: scale(0.95);
        }
        
        .pin-key.empty {
            visibility: hidden;
        }
        
        .pin-key.backspace {
            font-size: 1.2rem;
        }
        
        .pin-error {
            color: #ffcccc;
            font-size: 0.85rem;
            margin-top: 15px;
            min-height: 24px;
        }
        
        /* Setup Screen */
        .setup-card {
            background: rgba(255,255,255,0.95);
            border-radius: var(--radius);
            padding: 30px;
            width: 100%;
            max-width: 350px;
            color: var(--dark);
        }
        
        .setup-card h2 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--dark);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.9rem;
            opacity: 0;
            transition: all 0.3s;
            z-index: 300;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            background: var(--success);
        }
        
        .toast.error {
            background: var(--danger);
        }
        
        /* Add new bedrijf inline */
        .add-bedrijf-row, .add-entity-row {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .add-bedrijf-row input, .add-entity-row input {
            flex: 1;
        }
        
        /* Section divider */
        .section-divider {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            color: var(--secondary);
            font-size: 0.8rem;
            text-transform: uppercase;
        }
        
        .section-divider::before,
        .section-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #dee2e6;
        }
        
        /* Hidden */
        .hidden {
            display: none !important;
        }
        
        /* Scrollable chips */
        .bedrijf-select-container {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <!-- PIN Screen -->
    <div class="pin-screen active" id="pinScreen">
        <div id="pinLogin">
            <h1 class="pin-title">ZorgAnalyst Pro</h1>
            <p class="pin-subtitle">Voer uw PIN in om door te gaan</p>
            <div class="pin-dots" id="pinDots">
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
            </div>
            <div class="pin-keypad" id="pinKeypad">
                <button class="pin-key" data-key="1">1</button>
                <button class="pin-key" data-key="2">2</button>
                <button class="pin-key" data-key="3">3</button>
                <button class="pin-key" data-key="4">4</button>
                <button class="pin-key" data-key="5">5</button>
                <button class="pin-key" data-key="6">6</button>
                <button class="pin-key" data-key="7">7</button>
                <button class="pin-key" data-key="8">8</button>
                <button class="pin-key" data-key="9">9</button>
                <button class="pin-key empty"></button>
                <button class="pin-key" data-key="0">0</button>
                <button class="pin-key backspace" data-key="back"><i class="fas fa-backspace"></i></button>
            </div>
            <p class="pin-error" id="pinError"></p>
        </div>
        
        <div id="pinSetup" class="hidden">
            <div class="setup-card">
                <h2><i class="fas fa-user-plus"></i> Account Instellen</h2>
                <div class="form-group">
                    <label class="required">Uw naam</label>
                    <input type="text" class="form-control" id="setupName" placeholder="Voornaam Achternaam">
                </div>
                
                <!-- Werkgever selectie -->
                <div class="form-group">
                    <label class="required">Werkgever type</label>
                    <select class="form-control" id="setupWerkgeverType" onchange="toggleWerkgeverDetails()">
                        <option value="">-- Selecteer --</option>
                        <option value="gemeente">Gemeente</option>
                        <option value="zorgkantoor">Zorgkantoor</option>
                    </select>
                </div>
                
                <div id="gemeenteSelectDiv" class="form-group" style="display:none">
                    <label class="required">Gemeente</label>
                    <select class="form-control" id="setupGemeente" onchange="toggleGemeenteAnders()">
                        <option value="">-- Selecteer gemeente --</option>
                        <optgroup label="Gooi en Vechtstreek">
                            <option value="Hilversum">Hilversum</option>
                            <option value="Gooise Meren">Gooise Meren (Bussum/Naarden/Muiden)</option>
                            <option value="Huizen">Huizen</option>
                            <option value="Blaricum">Blaricum</option>
                            <option value="Laren">Laren</option>
                            <option value="Wijdemeren">Wijdemeren</option>
                            <option value="Weesp">Weesp</option>
                        </optgroup>
                        <optgroup label="Regio Midden-Nederland">
                            <option value="Utrecht">Utrecht</option>
                            <option value="Amersfoort">Amersfoort</option>
                            <option value="Almere">Almere</option>
                            <option value="Lelystad">Lelystad</option>
                            <option value="Zeist">Zeist</option>
                            <option value="Nieuwegein">Nieuwegein</option>
                            <option value="Houten">Houten</option>
                            <option value="Veenendaal">Veenendaal</option>
                            <option value="De Bilt">De Bilt</option>
                            <option value="Soest">Soest</option>
                            <option value="Baarn">Baarn</option>
                            <option value="Bunschoten">Bunschoten-Spakenburg</option>
                            <option value="Leusden">Leusden</option>
                            <option value="Woerden">Woerden</option>
                            <option value="IJsselstein">IJsselstein</option>
                            <option value="Stichtse Vecht">Stichtse Vecht</option>
                            <option value="Utrechtse Heuvelrug">Utrechtse Heuvelrug</option>
                            <option value="Wijk bij Duurstede">Wijk bij Duurstede</option>
                            <option value="De Ronde Venen">De Ronde Venen</option>
                            <option value="Rhenen">Rhenen</option>
                            <option value="Renswoude">Renswoude</option>
                            <option value="Woudenberg">Woudenberg</option>
                            <option value="Bunnik">Bunnik</option>
                            <option value="Lopik">Lopik</option>
                            <option value="Oudewater">Oudewater</option>
                            <option value="Montfoort">Montfoort</option>
                            <option value="Eemnes">Eemnes</option>
                            <option value="Zeewolde">Zeewolde</option>
                            <option value="Nijkerk">Nijkerk</option>
                            <option value="Barneveld">Barneveld</option>
                        </optgroup>
                        <optgroup label="Overige gemeenten">
                            <option value="Amsterdam">Amsterdam</option>
                            <option value="Rotterdam">Rotterdam</option>
                            <option value="Den Haag">'s-Gravenhage (Den Haag)</option>
                            <option value="Eindhoven">Eindhoven</option>
                            <option value="Groningen">Groningen</option>
                            <option value="Tilburg">Tilburg</option>
                            <option value="Breda">Breda</option>
                            <option value="Nijmegen">Nijmegen</option>
                            <option value="Apeldoorn">Apeldoorn</option>
                            <option value="Arnhem">Arnhem</option>
                            <option value="Haarlem">Haarlem</option>
                            <option value="Enschede">Enschede</option>
                            <option value="Haarlemmermeer">Haarlemmermeer</option>
                            <option value="Zaanstad">Zaanstad</option>
                            <option value="Den Bosch">'s-Hertogenbosch</option>
                            <option value="Zwolle">Zwolle</option>
                            <option value="Zoetermeer">Zoetermeer</option>
                            <option value="Leeuwarden">Leeuwarden</option>
                            <option value="Leiden">Leiden</option>
                            <option value="Maastricht">Maastricht</option>
                            <option value="Dordrecht">Dordrecht</option>
                            <option value="Ede">Ede</option>
                        </optgroup>
                        <option value="Anders">Anders (vul in)</option>
                    </select>
                    <input type="text" class="form-control" id="setupGemeenteAnders" placeholder="Vul gemeentenaam in" style="display:none;margin-top:8px">
                </div>
                
                <div id="zorgkantoorSelectDiv" class="form-group" style="display:none">
                    <label class="required">Zorgkantoor</label>
                    <select class="form-control" id="setupZorgkantoor" onchange="toggleZorgkantoorAnders()">
                        <option value="">-- Selecteer zorgkantoor --</option>
                        <option value="Zilveren Kruis">Zilveren Kruis Zorgkantoor</option>
                        <option value="VGZ">VGZ Zorgkantoor</option>
                        <option value="CZ">CZ Zorgkantoor</option>
                        <option value="Menzis">Menzis Zorgkantoor</option>
                        <option value="Zorg en Zekerheid">Zorg en Zekerheid</option>
                        <option value="DSW">DSW Zorgkantoor</option>
                        <option value="Salland">Salland Zorgkantoor</option>
                        <option value="Anders">Anders (vul in)</option>
                    </select>
                    <input type="text" class="form-control" id="setupZorgkantoorAnders" placeholder="Vul zorgkantoor naam in" style="display:none;margin-top:8px">
                </div>
                
                <div class="form-group">
                    <label class="required">Kies een 4-cijferige PIN</label>
                    <input type="password" class="form-control" id="setupPin" maxlength="4" pattern="[0-9]*" inputmode="numeric" placeholder="••••">
                </div>
                <div class="form-group">
                    <label class="required">Bevestig PIN</label>
                    <input type="password" class="form-control" id="setupPinConfirm" maxlength="4" pattern="[0-9]*" inputmode="numeric" placeholder="••••">
                </div>
                <button class="btn btn-primary" id="setupSubmit">
                    <i class="fas fa-check"></i> Account Aanmaken
                </button>
                <p class="pin-error" id="setupError" style="color: var(--danger); margin-top: 10px;"></p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="header">
            <div class="header-top">
                <h1>ZorgAnalyst Pro Mobile</h1>
                <div class="gps-indicator" id="gpsIndicator">
                    <div class="gps-dot"></div>
                    <span id="gpsStatus">GPS</span>
                </div>
            </div>
            <p class="subtitle" id="headerWerkgever">Veldwerk Zorgcriminaliteit</p>
            </div>
        </header>

        <!-- Dashboard Screen -->
        <div class="screen active" id="dashboardScreen">
            <div class="container">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-chart-line"></i>
                        Dashboard
                    </div>
                    <p style="margin-bottom: 15px; color: var(--secondary);">Welkom, <span id="userName">Gebruiker</span></p>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="statMeldingen">0</div>
                            <div class="stat-label">Meldingen</div>
                        </div>
                        <div class="stat-card secondary">
                            <div class="stat-number" id="statBedrijven">0</div>
                            <div class="stat-label">Entiteiten</div>
                        </div>
                    </div>
                    <button class="btn btn-primary" style="margin-top:15px;width:100%" onclick="switchScreen('meldingen')">
                        <i class="fas fa-list"></i> Bekijk Meldingen
                    </button>
                </div>
            </div>
        </div>

        <!-- Nieuwe Melding Screen -->
        <div class="screen" id="nieuwScreen">
            <div class="container">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-plus-circle"></i>
                        Nieuwe Melding
                    </div>
                    
                    <!-- GPS Info -->
                    <div class="gps-info" id="gpsInfo">
                        <strong><i class="fas fa-map-marker-alt"></i> GPS Locatie</strong>
                        <div class="gps-coords" id="gpsCoords">Locatie wordt bepaald...</div>
                    </div>
                    
                    <!-- Entiteiten Selectie -->
                    <div class="section-divider">Betrokken Entiteiten</div>
                    
                    <!-- Bedrijf Selectie (Dropdown) -->
                    <div class="form-group">
                        <label>Zorgaanbieder / Bedrijf</label>
                        <select class="form-control" id="bedrijfSelect">
                            <option value="">-- Selecteer bedrijf --</option>
                        </select>
                        <div class="add-entity-row">
                            <input type="text" class="form-control" id="nieuwBedrijfInput" placeholder="Of voeg nieuw bedrijf toe...">
                            <button class="btn btn-primary btn-sm" id="addBedrijfBtn" style="width: auto; padding: 10px 14px;">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Zorglocatie Selectie (Dropdown) -->
                    <div class="form-group">
                        <label>Zorglocatie</label>
                        <select class="form-control" id="locatieSelect">
                            <option value="">-- Selecteer locatie --</option>
                        </select>
                        <div class="add-entity-row">
                            <input type="text" class="form-control" id="nieuwLocatieInput" placeholder="Of voeg nieuwe locatie toe...">
                            <button class="btn btn-primary btn-sm" id="addLocatieBtn" style="width: auto; padding: 10px 14px;">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Zorgverlener Selectie (Dropdown) -->
                    <div class="form-group">
                        <label>Zorgverlener (persoon/ZZP'er)</label>
                        <select class="form-control" id="zorgverlenerSelect">
                            <option value="">-- Selecteer zorgverlener --</option>
                        </select>
                        <div class="add-entity-row">
                            <input type="text" class="form-control" id="nieuwZorgverlenerInput" placeholder="Of voeg nieuwe zorgverlener toe...">
                            <button class="btn btn-primary btn-sm" id="addZorgverlenerBtn" style="width: auto; padding: 10px 14px;">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <label style="display:flex;align-items:center;gap:8px;margin-top:8px;font-size:0.85rem;color:var(--secondary)">
                            <input type="checkbox" id="zorgverlenerIsZzp"> Dit is een ZZP'er
                        </label>
                    </div>
                    
                    <!-- Adres -->
                    <div class="section-divider">Locatie Adres</div>
                    
                    <div class="form-row">
                        <div class="form-group autocomplete-container">
                            <label class="required">Straatnaam</label>
                            <input type="text" class="form-control" id="straatnaamInput" placeholder="Begin met typen..." autocomplete="off">
                            <div class="autocomplete-list" id="straatnaamList"></div>
                        </div>
                        <div class="form-group">
                            <label class="required">Huisnr.</label>
                            <input type="text" class="form-control" id="huisnummerInput" placeholder="123">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Toevoeging</label>
                        <input type="text" class="form-control" id="toevoegingInput" placeholder="A, B, etc.">
                    </div>
                    
                    <!-- Type Zorgverlening -->
                    <div class="section-divider">Classificatie</div>
                    
                    <div class="form-group">
                        <label class="required">Type zorgverlening</label>
                        <select class="form-control" id="typeZorgverlening">
                            <option value="">-- Selecteer --</option>
                            <optgroup label="Eerstelijnszorg">
                                <option value="huisarts">Huisarts</option>
                                <option value="apotheek">Apotheek</option>
                                <option value="fysiotherapie">Fysiotherapie</option>
                                <option value="tandarts">Tandarts</option>
                                <option value="verloskundige">Verloskundige</option>
                                <option value="dietetiek">DiÃ«tetiek</option>
                                <option value="logopedie">Logopedie</option>
                                <option value="ergotherapie">Ergotherapie</option>
                                <option value="podotherapie">Podotherapie</option>
                            </optgroup>
                            <optgroup label="Tweedelijnszorg">
                                <option value="ziekenhuis">Ziekenhuis</option>
                                <option value="specialist">Medisch specialist</option>
                                <option value="ggz">GGZ instelling</option>
                                <option value="revalidatie">Revalidatie</option>
                            </optgroup>
                            <optgroup label="Langdurige zorg">
                                <option value="verpleeghuis">Verpleeghuis</option>
                                <option value="verzorgingshuis">Verzorgingshuis</option>
                                <option value="thuiszorg">Thuiszorg</option>
                                <option value="gehandicaptenzorg">Gehandicaptenzorg</option>
                                <option value="wlz">WLZ instelling</option>
                            </optgroup>
                            <optgroup label="PGB">
                                <option value="pgb-zorg">PGB zorgverlener</option>
                                <option value="pgb-begeleiding">PGB begeleiding</option>
                                <option value="pgb-wonen">PGB beschermd wonen</option>
                            </optgroup>
                            <optgroup label="Overig">
                                <option value="wmo">WMO voorziening</option>
                                <option value="jeugdzorg">Jeugdzorg</option>
                                <option value="ambulance">Ambulancedienst</option>
                                <option value="overig">Overig</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <!-- Type Zorgcriminaliteit -->
                    <div class="form-group">
                        <label class="required">Type zorgcriminaliteit</label>
                        <select class="form-control" id="typeCriminaliteit">
                            <option value="">-- Selecteer --</option>
                            <optgroup label="Declaratiefraude">
                                <option value="declaratie-niet-geleverd">Declaratie niet-geleverde zorg</option>
                                <option value="declaratie-upcoding">Upcoding (duurder declareren)</option>
                                <option value="declaratie-dubbel">Dubbele declaraties</option>
                                <option value="declaratie-fictief">Fictieve patiÃ«nten</option>
                                <option value="declaratie-overig">Overige declaratiefraude</option>
                            </optgroup>
                            <optgroup label="PGB Fraude">
                                <option value="pgb-niet-geleverd">PGB niet-geleverde zorg</option>
                                <option value="pgb-kwaliteit">PGB ondermaatse zorg</option>
                                <option value="pgb-dwang">PGB dwang/uitbuiting</option>
                                <option value="pgb-familie">PGB familieconstructie</option>
                                <option value="pgb-overig">Overige PGB fraude</option>
                            </optgroup>
                            <optgroup label="Identiteitsfraude">
                                <option value="id-misbruik">Misbruik identiteit</option>
                                <option value="id-diefstal">Identiteitsdiefstal</option>
                                <option value="id-vervalsing">Vervalsing documenten</option>
                            </optgroup>
                            <optgroup label="Kwaliteit & Veiligheid">
                                <option value="kwaliteit-verwaarlozing">Verwaarlozing</option>
                                <option value="kwaliteit-mishandeling">Mishandeling</option>
                                <option value="kwaliteit-medicatie">Medicatiefraude/-misbruik</option>
                                <option value="kwaliteit-bevoegdheid">Onbevoegde zorgverlening</option>
                            </optgroup>
                            <optgroup label="Ondermijning">
                                <option value="ondermijning-witwassen">Witwassen via zorg</option>
                                <option value="ondermijning-vastgoed">Vastgoedfraude zorglocaties</option>
                                <option value="ondermijning-netwerk">Crimineel netwerk</option>
                                <option value="ondermijning-dwang">Gedwongen zorgafname</option>
                            </optgroup>
                            <optgroup label="Overig">
                                <option value="corruptie">Corruptie/omkoping</option>
                                <option value="subsidie">Subsidiefraude</option>
                                <option value="overig">Overig</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <!-- Omschrijving met Speech-to-Text -->
                    <div class="section-divider">Omschrijving</div>
                    
                    <div class="form-group">
                        <label class="required">Beschrijving zorgcriminaliteit</label>
                        <div class="speech-container">
                            <textarea class="form-control" id="omschrijvingInput" placeholder="Beschrijf de waarneming zo gedetailleerd mogelijk..." style="padding-right: 60px;"></textarea>
                            <button type="button" class="speech-btn" id="speechBtn" title="Spraak naar tekst">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                        <div class="speech-status" id="speechStatus">
                            <span class="audio-bars">
                                <span class="audio-bar"></span>
                                <span class="audio-bar"></span>
                                <span class="audio-bar"></span>
                                <span class="audio-bar"></span>
                                <span class="audio-bar"></span>
                            </span>
                            <span class="status-text">Tik op de microfoon voor spraakherkenning</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-success" id="saveMeldingBtn">
                        <i class="fas fa-save"></i> Melding Opslaan
                    </button>
                </div>
            </div>
        </div>

        <!-- Meldingen Screen -->
        <div class="screen" id="meldingenScreen">
            <div class="container">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-list"></i>
                        Alle Meldingen
                    </div>
                    <!-- Zoekfunctie -->
                    <div class="form-group" style="margin-bottom: 15px;">
                        <div style="position:relative">
                            <i class="fas fa-search" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--secondary)"></i>
                            <input type="text" class="form-control" id="meldingenZoek" placeholder="Zoeken in meldingen..." style="padding-left:38px" oninput="filterMeldingen()">
                        </div>
                    </div>
                    <div id="meldingenCount" style="font-size:0.85rem;color:var(--secondary);margin-bottom:10px"></div>
                    <div id="alleMeldingen">
                        <p style="color: var(--secondary); text-align: center; padding: 20px 0;">
                            Nog geen meldingen
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instellingen Screen -->
        <div class="screen" id="instellingenScreen">
            <div class="container">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-user"></i>
                        Profiel
                    </div>
                    <div class="form-group">
                        <label>Naam</label>
                        <input type="text" class="form-control" id="settingsName">
                    </div>
                    <div class="form-group">
                        <label>Werkgever</label>
                        <input type="text" class="form-control" id="settingsWerkgever" readonly style="background:#f0f0f0">
                    </div>
                    <button class="btn btn-primary" id="saveProfileBtn">
                        <i class="fas fa-save"></i> Opslaan
                    </button>
                </div>
                
                <!-- Bedrijven Beheren -->
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-building"></i>
                        Bedrijven Beheren
                    </div>
                    <div class="form-group">
                        <select class="form-control" id="bedrijvenBeheerSelect" size="4" style="height:auto">
                        </select>
                    </div>
                    <div class="add-entity-row">
                        <input type="text" class="form-control" id="nieuwBedrijfSettings" placeholder="Nieuw bedrijf toevoegen...">
                        <button class="btn btn-primary btn-sm" id="addBedrijfSettingsBtn" style="width:auto;padding:10px 14px">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <button class="btn btn-danger btn-sm" id="deleteBedrijfBtn" style="margin-top:10px;width:100%">
                        <i class="fas fa-trash"></i> Verwijder Geselecteerde
                    </button>
                </div>
                
                <!-- Locaties Beheren -->
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-map-marker-alt"></i>
                        Zorglocaties Beheren
                    </div>
                    <div class="form-group">
                        <select class="form-control" id="locatiesBeheerSelect" size="4" style="height:auto">
                        </select>
                    </div>
                    <div class="add-entity-row">
                        <input type="text" class="form-control" id="nieuwLocatieSettings" placeholder="Locatie naam...">
                        <button class="btn btn-primary btn-sm" id="addLocatieSettingsBtn" style="width:auto;padding:10px 14px">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <input type="text" class="form-control" id="nieuwLocatieAdresSettings" placeholder="Adres (optioneel)" style="margin-top:8px">
                    <button class="btn btn-danger btn-sm" id="deleteLocatieBtn" style="margin-top:10px;width:100%">
                        <i class="fas fa-trash"></i> Verwijder Geselecteerde
                    </button>
                </div>
                
                <!-- Zorgverleners Beheren -->
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-user-nurse"></i>
                        Zorgverleners Beheren
                    </div>
                    <div class="form-group">
                        <select class="form-control" id="zorgverlenersBeheerSelect" size="4" style="height:auto">
                        </select>
                    </div>
                    <div class="add-entity-row">
                        <input type="text" class="form-control" id="nieuwZorgverlenerSettings" placeholder="Naam zorgverlener...">
                        <button class="btn btn-primary btn-sm" id="addZorgverlenerSettingsBtn" style="width:auto;padding:10px 14px">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div style="display:flex;gap:8px;margin-top:8px">
                        <input type="text" class="form-control" id="nieuwZvFunctieSettings" placeholder="Functie" style="flex:1">
                        <label style="display:flex;align-items:center;gap:5px;white-space:nowrap;font-size:0.85rem">
                            <input type="checkbox" id="nieuwZvIsZzpSettings"> ZZP
                        </label>
                    </div>
                    <button class="btn btn-danger btn-sm" id="deleteZorgverlenerBtn" style="margin-top:10px;width:100%">
                        <i class="fas fa-trash"></i> Verwijder Geselecteerde
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-download"></i>
                        Export
                    </div>
                    <p style="font-size: 0.85rem; color: var(--secondary); margin-bottom: 15px;">
                        Exporteer alle meldingen naar JSON voor import in ZorgAnalyst Pro.
                    </p>
                    <button class="btn btn-success" id="exportJsonBtn">
                        <i class="fas fa-file-export"></i> Export JSON
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-shield-alt"></i>
                        Beveiliging
                    </div>
                    <button class="btn btn-outline" id="changePinBtn" style="margin-bottom: 10px;">
                        <i class="fas fa-key"></i> PIN Wijzigen
                    </button>
                    <button class="btn btn-danger" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Uitloggen
                    </button>
                </div>
                
                <div style="text-align: center; padding: 20px; color: var(--secondary); font-size: 0.8rem;">
                    <strong>ZorgAnalyst Pro Mobile</strong><br>
                    Versie 2.1.0 PWA<br><br>
                    © 2025 Knowledge by Data
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-item active" data-screen="dashboard">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </button>
            <button class="nav-item" data-screen="nieuw">
                <i class="fas fa-plus-circle"></i>
                <span>Nieuwe</span>
            </button>
            <button class="nav-item" data-screen="meldingen">
                <i class="fas fa-list"></i>
                <span>Meldingen</span>
            </button>
            <button class="nav-item" data-screen="instellingen">
                <i class="fas fa-cog"></i>
                <span>Instellingen</span>
            </button>
        </nav>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        'use strict';
        
        // =====================================================
        // STRAATNAMEN HILVERSUM (selectie van meest voorkomende)
        // =====================================================
        const STRAATNAMEN_HILVERSUM = [
            "'s-Gravelandseweg", "1e Loswal", "1e Nieuwstraat", "1e Oosterstraat",
            "2e Loswal", "2e Nieuwstraat", "2e Oosterstraat", "3e Oosterstraat",
            "Aardjesberg", "Achterom", "Albertus Perkstraat", "Alexanderlaan",
            "Anna Paulownalaan", "Annastraat", "Asteroid", "Bachlaan",
            "Badhuislaan", "Bakkerstraat", "Beatrixpark", "Beethovenlaan",
            "Bergweg", "Binnendoor", "Bloemstraat", "Bosdrift",
            "Boslaan", "Boterbloemweg", "Brediusweg", "Brinkweg",
            "Burgemeester van Hellenberg Hubarlaan", "Capitool", "Ceintuurbaan", "Colosseum",
            "Cornelis Drebbelstraat", "CrailoÃ«rweg", "De Gijselaar", "Diependaalselaan",
            "Eemnesserweg", "Egelshoek", "Eikbosserweg", "Eikenlaan",
            "Emmastraat", "Erfgooiersstraat", "Forum", "Frederik van Eedenlaan",
            "Geuzenweg", "Gijsbrecht van Amstelstraat", "Gladiolenstraat", "Godelindeweg",
            "Graaf Florislaan", "Gravenlandseweg", "Groest", "Havenstraat",
            "Herenstraat", "Het Hoog", "Hilversumse Meentweg", "Hilvertsweg",
            "Hoge Larenseweg", "Hoge Naarderweg", "Holleweg", "Huizerweg",
            "Irisstraat", "Jacob van Campenlaan", "Jan van der Heijdenstraat", "Johannes Geradtsweg",
            "Jonkerweg", "Julianaplein", "Kamerlingh Onnesweg", "Kampstraat",
            "Kerkbrink", "Kerkstraat", "Kleine Drift", "Koningsstraat",
            "Koppelweg", "Korte Noorderweg", "Laan 1940-1945", "Laapersveld",
            "Langestraat", "Larenseweg", "Liebergerweg", "Lijsterweg",
            "Loosdrechtseweg", "Maartensdijkseweg", "Marktplein", "Mediapark",
            "Melkpad", "Merelstraat", "Meteorenweg", "Middenweg",
            "Mussenstraat", "Naarderstraat", "Neuweg", "Nieuwe Crailoseweg",
            "Nieuwe Havenweg", "Nieuwe 's-Gravelandseweg", "Nimrodpark", "Noorderweg",
            "Noodweg", "Obrechtstraat", "Oude Amersfoortseweg", "Oude Enghweg",
            "Oude Torenstraat", "Palmboomstraat", "Pauwenstraat", "Pelikaanstraat",
            "Planetenstraat", "Plataanweg", "Prins Bernhardstraat", "Putter",
            "Randweg", "Rembrandtlaan", "Rietgors", "Rossinilaan",
            "Schapenkamp", "Schoolstraat", "Schoutenstraat", "Sibeliuslaan",
            "Sint Annastraat", "Sint Vitusstraat", "Siriusstraat", "Snelliuslaan",
            "Soestdijkerstraatweg", "Sophialaan", "Spoorstraat", "Stationsplein",
            "Stationsstraat", "Steijnlaan", "Sumatralaan", "Taludweg",
            "Trompenberg", "Tuinstraat", "Utrechtseweg", "Vaartweg",
            "Van Brakellaan", "Van Ghentlaan", "Van Riebeeckweg", "Veerstraat",
            "Verbindingsweg", "Vermeerstraat", "Violenstraat", "Vondelstraat",
            "Weerdestein", "Westerveld", "Willibrordstraat", "Zeverijnstraat",
            "Zuiderweg", "Zwaluwstraat"
        ].sort();
        
        // =====================================================
        // APP STATE
        // =====================================================
        const APP = {
            currentUser: null,
            currentPin: '',
            gpsPosition: null,
            gpsWatchId: null,
            speechRecognition: null,
            isRecording: false,
            selectedBedrijven: []
        };
        
        // =====================================================
        // LOCALSTORAGE KEYS
        // =====================================================
        const STORAGE_KEYS = {
            USER: 'zorganalyst_user',
            PIN: 'zorganalyst_pin',
            MELDINGEN: 'zorganalyst_meldingen',
            BEDRIJVEN: 'zorganalyst_bedrijven',
            LOCATIES: 'zorganalyst_locaties',
            ZORGVERLENERS: 'zorganalyst_zorgverleners'
        };
        
        // =====================================================
        // UTILITY FUNCTIONS
        // =====================================================
        function $(selector) {
            return document.querySelector(selector);
        }
        
        function $$(selector) {
            return document.querySelectorAll(selector);
        }
        
        function showToast(message, type = '') {
            const toast = $('#toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(() => toast.className = 'toast', 3000);
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('nl-NL', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function generateId() {
            return 'M' + Date.now() + Math.random().toString(36).substr(2, 5).toUpperCase();
        }
        
        // =====================================================
        // DATA FUNCTIONS
        // =====================================================
        function getUser() {
            const data = localStorage.getItem(STORAGE_KEYS.USER);
            return data ? JSON.parse(data) : null;
        }
        
        function saveUser(user) {
            localStorage.setItem(STORAGE_KEYS.USER, JSON.stringify(user));
        }
        
        function getPin() {
            return localStorage.getItem(STORAGE_KEYS.PIN) || '';
        }
        
        function savePin(pin) {
            localStorage.setItem(STORAGE_KEYS.PIN, pin);
        }
        
        function getMeldingen() {
            const data = localStorage.getItem(STORAGE_KEYS.MELDINGEN);
            return data ? JSON.parse(data) : [];
        }
        
        function saveMeldingen(meldingen) {
            localStorage.setItem(STORAGE_KEYS.MELDINGEN, JSON.stringify(meldingen));
        }
        
        function getBedrijven() {
            const data = localStorage.getItem(STORAGE_KEYS.BEDRIJVEN);
            return data ? JSON.parse(data) : [];
        }
        
        function saveBedrijven(bedrijven) {
            localStorage.setItem(STORAGE_KEYS.BEDRIJVEN, JSON.stringify(bedrijven));
        }
        
        function addBedrijf(naam) {
            if (!naam || naam.trim() === '') return false;
            const bedrijven = getBedrijven();
            const normalized = naam.trim();
            if (!bedrijven.includes(normalized)) {
                bedrijven.push(normalized);
                bedrijven.sort();
                saveBedrijven(bedrijven);
                return true;
            }
            return false;
        }
        
        function removeBedrijf(naam) {
            let bedrijven = getBedrijven();
            bedrijven = bedrijven.filter(b => b !== naam);
            saveBedrijven(bedrijven);
        }
        
        // Locaties functies
        function getLocaties() {
            const data = localStorage.getItem(STORAGE_KEYS.LOCATIES);
            return data ? JSON.parse(data) : [];
        }
        
        function saveLocaties(locaties) {
            localStorage.setItem(STORAGE_KEYS.LOCATIES, JSON.stringify(locaties));
        }
        
        function addLocatie(locatie) {
            if (!locatie || !locatie.naam || locatie.naam.trim() === '') return null;
            const locaties = getLocaties();
            const normalized = {
                id: 'LOC-' + Date.now(),
                naam: locatie.naam.trim(),
                adres: locatie.adres || '',
                bedrijf: locatie.bedrijf || '',
                aangemaakt: new Date().toISOString()
            };
            if (!locaties.find(l => l.naam === normalized.naam && l.adres === normalized.adres)) {
                locaties.push(normalized);
                locaties.sort((a, b) => a.naam.localeCompare(b.naam));
                saveLocaties(locaties);
                return normalized;
            }
            return locaties.find(l => l.naam === normalized.naam);
        }
        
        function removeLocatie(id) {
            let locaties = getLocaties();
            locaties = locaties.filter(l => l.id !== id);
            saveLocaties(locaties);
        }
        
        // Zorgverleners functies
        function getZorgverleners() {
            const data = localStorage.getItem(STORAGE_KEYS.ZORGVERLENERS);
            return data ? JSON.parse(data) : [];
        }
        
        function saveZorgverleners(zorgverleners) {
            localStorage.setItem(STORAGE_KEYS.ZORGVERLENERS, JSON.stringify(zorgverleners));
        }
        
        function addZorgverlener(zv) {
            if (!zv || !zv.naam || zv.naam.trim() === '') return null;
            const zorgverleners = getZorgverleners();
            const normalized = {
                id: 'ZV-' + Date.now(),
                naam: zv.naam.trim(),
                functie: zv.functie || '',
                isZzp: zv.isZzp || false,
                bedrijven: zv.bedrijven || [],
                locaties: zv.locaties || [],
                aangemaakt: new Date().toISOString()
            };
            if (!zorgverleners.find(z => z.naam === normalized.naam)) {
                zorgverleners.push(normalized);
                zorgverleners.sort((a, b) => a.naam.localeCompare(b.naam));
                saveZorgverleners(zorgverleners);
                return normalized;
            }
            return zorgverleners.find(z => z.naam === normalized.naam);
        }
        
        function removeZorgverlener(id) {
            let zorgverleners = getZorgverleners();
            zorgverleners = zorgverleners.filter(z => z.id !== id);
            saveZorgverleners(zorgverleners);
        }
        
        // =====================================================
        // GPS FUNCTIONS
        // =====================================================
        function initGPS() {
            if (!navigator.geolocation) {
                updateGPSStatus('error', 'GPS niet beschikbaar');
                return;
            }
            
            updateGPSStatus('searching', 'GPS zoeken...');
            
            // High accuracy options
            const gpsOptions = {
                enableHighAccuracy: true,
                timeout: 30000,
                maximumAge: 0
            };
            
            // Use watchPosition for continuous updates
            APP.gpsWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    APP.gpsPosition = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date().toISOString()
                    };
                    updateGPSStatus('active', `GPS actief (Â±${Math.round(position.coords.accuracy)}m)`);
                    updateGPSInfo();
                },
                (error) => {
                    console.error('GPS Error:', error);
                    let errorMsg = 'GPS fout';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'GPS geweigerd';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'Positie onbekend';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'GPS timeout';
                            break;
                    }
                    updateGPSStatus('error', errorMsg);
                    
                    // Retry after error
                    setTimeout(() => {
                        if (!APP.gpsPosition) {
                            navigator.geolocation.getCurrentPosition(
                                (pos) => {
                                    APP.gpsPosition = {
                                        latitude: pos.coords.latitude,
                                        longitude: pos.coords.longitude,
                                        accuracy: pos.coords.accuracy,
                                        timestamp: new Date().toISOString()
                                    };
                                    updateGPSStatus('active', `GPS actief (Â±${Math.round(pos.coords.accuracy)}m)`);
                                    updateGPSInfo();
                                },
                                () => {},
                                { enableHighAccuracy: false, timeout: 10000, maximumAge: 60000 }
                            );
                        }
                    }, 5000);
                },
                gpsOptions
            );
        }
        
        function updateGPSStatus(status, text) {
            const indicator = $('#gpsIndicator');
            const statusEl = $('#gpsStatus');
            
            indicator.className = 'gps-indicator ' + status;
            statusEl.textContent = text;
        }
        
        function updateGPSInfo() {
            const gpsInfo = $('#gpsInfo');
            const gpsCoords = $('#gpsCoords');
            
            if (APP.gpsPosition) {
                gpsInfo.className = 'gps-info success';
                gpsCoords.innerHTML = `
                    <strong>Lat:</strong> ${APP.gpsPosition.latitude.toFixed(6)}<br>
                    <strong>Lon:</strong> ${APP.gpsPosition.longitude.toFixed(6)}<br>
                    <strong>Nauwkeurigheid:</strong> Â±${Math.round(APP.gpsPosition.accuracy)} meter
                `;
            } else {
                gpsInfo.className = 'gps-info';
                gpsCoords.textContent = 'Locatie wordt bepaald...';
            }
        }
        
        // =====================================================
        // SPEECH TO TEXT - ROBUST VERSION 3.0
        // =====================================================
        // Deze implementatie lost de volgende problemen op:
        // 1. Verlies van tekst bij auto-restart
        // 2. Gemiste interim results
        // 3. Betere buffering en state management
        // =====================================================
        
        const SpeechEngine = {
            // Core state
            recognition: null,
            isListening: false,
            shouldRestart: false,
            
            // Transcript management - KRITIEK voor geen verlies
            confirmedText: '',      // 100% bevestigde tekst (final results)
            pendingText: '',        // Nog niet bevestigde tekst (interim)
            sessionBuffer: [],      // Buffer van alle final results deze sessie
            
            // Restart management
            restartCount: 0,
            maxRestarts: 50,        // Veel hoger - browser stopt vaak na ~60 sec
            restartDelay: 50,       // Snellere restart
            
            // Timing
            lastResultTime: 0,
            sessionStartTime: 0,
            
            // UI elements cache
            textarea: null,
            statusEl: null,
            buttonEl: null,
            
            init() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                
                if (!SpeechRecognition) {
                    this.showUnsupported();
                    return false;
                }
                
                // Cache UI elements
                this.textarea = $('#omschrijvingInput');
                this.statusEl = $('#speechStatus');
                this.buttonEl = $('#speechBtn');
                
                this.createRecognition();
                return true;
            },
            
            createRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                
                // KRITIEKE INSTELLINGEN
                this.recognition.continuous = true;       // Blijf luisteren
                this.recognition.interimResults = true;   // Toon live wat je hoort
                this.recognition.lang = 'nl-NL';          // Nederlands
                this.recognition.maxAlternatives = 1;     // Sneller met 1 alternatief
                
                this.bindEvents();
            },
            
            bindEvents() {
                // =============== RESULT EVENT ===============
                // Dit is waar de magie gebeurt
                this.recognition.onresult = (event) => {
                    this.lastResultTime = Date.now();
                    
                    let newFinalText = '';
                    let newInterimText = '';
                    
                    // Loop door ALLE resultaten (niet alleen vanaf resultIndex)
                    // Dit voorkomt verlies bij bepaalde edge cases
                    for (let i = 0; i < event.results.length; i++) {
                        const result = event.results[i];
                        const transcript = result[0].transcript;
                        
                        if (result.isFinal) {
                            newFinalText += transcript;
                        } else {
                            newInterimText += transcript;
                        }
                    }
                    
                    // Update confirmed text alleen als er nieuwe final text is
                    if (newFinalText && newFinalText !== this.confirmedText) {
                        this.confirmedText = newFinalText;
                        // Sla ook op in buffer voor extra veiligheid
                        this.sessionBuffer.push({
                            text: newFinalText,
                            time: Date.now()
                        });
                    }
                    
                    // Update pending (interim) text
                    this.pendingText = newInterimText;
                    
                    // Update UI
                    this.updateTextarea();
                    this.updateStatus('speaking');
                };
                
                // =============== START EVENT ===============
                this.recognition.onstart = () => {
                    this.isListening = true;
                    this.shouldRestart = true;
                    this.lastResultTime = Date.now();
                    this.updateUI('listening');
                    console.log('[Speech] Started - session active');
                };
                
                // =============== END EVENT ===============
                // KRITIEK: Hier gaat het vaak mis. Onze oplossing:
                // - Bewaar ALLES voordat we herstarten
                // - Gebruik shouldRestart flag i.p.v. isListening
                this.recognition.onend = () => {
                    console.log('[Speech] Ended - shouldRestart:', this.shouldRestart);
                    
                    // BELANGRIJK: Als er pending text was, voeg die toe aan confirmed
                    // Dit voorkomt verlies van de laatste gesproken woorden
                    if (this.pendingText.trim()) {
                        // Voeg pending toe als het niet al in confirmed zit
                        if (!this.confirmedText.endsWith(this.pendingText.trim())) {
                            this.confirmedText = this.confirmedText.trim() + ' ' + this.pendingText.trim();
                        }
                        this.pendingText = '';
                        this.updateTextarea();
                    }
                    
                    // Auto-restart als we nog moeten luisteren
                    if (this.shouldRestart && this.restartCount < this.maxRestarts) {
                        this.restartCount++;
                        
                        // Maak nieuwe recognition instance voor schone state
                        // Dit voorkomt veel bugs met stale state
                        setTimeout(() => {
                            if (this.shouldRestart) {
                                try {
                                    // Hergebruik bestaande instance
                                    this.recognition.start();
                                    console.log('[Speech] Restarted (#' + this.restartCount + ')');
                                } catch (e) {
                                    // Als start faalt, maak nieuwe instance
                                    console.log('[Speech] Restart failed, recreating...');
                                    this.createRecognition();
                                    try {
                                        this.recognition.start();
                                    } catch (e2) {
                                        console.error('[Speech] Recreation failed:', e2);
                                        this.forceStop();
                                    }
                                }
                            }
                        }, this.restartDelay);
                    } else if (this.restartCount >= this.maxRestarts) {
                        console.log('[Speech] Max restarts reached');
                        this.forceStop();
                        showToast('Spraakherkenning automatisch gestopt. Druk opnieuw op de microfoon.', 'error');
                    }
                };
                
                // =============== ERROR EVENT ===============
                this.recognition.onerror = (event) => {
                    console.error('[Speech] Error:', event.error);
                    
                    switch (event.error) {
                        case 'not-allowed':
                        case 'permission-denied':
                            this.forceStop();
                            showToast('Microfoon toegang geweigerd', 'error');
                            this.updateStatus('Geen microfoon toegang. Check browser instellingen.');
                            break;
                            
                        case 'no-speech':
                            // Normaal - gebruiker is even stil
                            // Doe niets, laat auto-restart zijn werk doen
                            this.updateStatus('Geen spraak gedetecteerd...');
                            break;
                            
                        case 'audio-capture':
                            this.forceStop();
                            showToast('Microfoon niet beschikbaar', 'error');
                            this.updateStatus('Microfoon niet gevonden');
                            break;
                            
                        case 'network':
                            // Tijdelijke netwerkfout - auto-restart zal dit oplossen
                            this.updateStatus('Netwerkfout, herverbinden...');
                            break;
                            
                        case 'aborted':
                            // Normaal bij handmatig stoppen
                            break;
                            
                        default:
                            this.updateStatus('Fout: ' + event.error);
                    }
                };
                
                // =============== SPEECH EVENTS (voor UI feedback) ===============
                this.recognition.onspeechstart = () => {
                    this.updateStatus('Spraak gedetecteerd - aan het transcriberen...');
                };
                
                this.recognition.onspeechend = () => {
                    if (this.isListening) {
                        this.updateStatus('Luisteren...');
                    }
                };
                
                this.recognition.onaudiostart = () => {
                    console.log('[Speech] Audio capture started');
                };
            },
            
            updateTextarea() {
                if (!this.textarea) return;
                
                // Combineer bestaande tekst + confirmed + pending
                let baseText = this.baseText || '';
                let fullText = baseText;
                
                // Voeg confirmed toe
                if (this.confirmedText.trim()) {
                    if (fullText && !fullText.endsWith(' ')) {
                        fullText += ' ';
                    }
                    fullText += this.confirmedText.trim();
                }
                
                // Voeg pending (interim) toe met visuele indicator
                if (this.pendingText.trim()) {
                    if (fullText && !fullText.endsWith(' ')) {
                        fullText += ' ';
                    }
                    fullText += this.pendingText;
                }
                
                this.textarea.value = fullText;
                
                // Auto-scroll naar beneden
                this.textarea.scrollTop = this.textarea.scrollHeight;
            },
            
            updateUI(state) {
                if (!this.buttonEl || !this.statusEl) return;
                
                switch (state) {
                    case 'listening':
                        this.buttonEl.classList.add('recording');
                        this.buttonEl.innerHTML = '<i class="fas fa-stop"></i>';
                        this.statusEl.innerHTML = '<span class="audio-bars"><span class="audio-bar"></span><span class="audio-bar"></span><span class="audio-bar"></span><span class="audio-bar"></span><span class="audio-bar"></span></span> <span class="status-text">Luisteren... Spreek nu.</span>';
                        this.statusEl.classList.add('recording');
                        if (this.textarea) this.textarea.classList.add('speech-active');
                        break;
                        
                    case 'stopped':
                        this.buttonEl.classList.remove('recording');
                        this.buttonEl.innerHTML = '<i class="fas fa-microphone"></i>';
                        this.statusEl.innerHTML = '<span class="audio-bars"><span class="audio-bar"></span><span class="audio-bar"></span><span class="audio-bar"></span><span class="audio-bar"></span><span class="audio-bar"></span></span> <span class="status-text">Tik op de microfoon voor spraakherkenning</span>';
                        this.statusEl.classList.remove('recording');
                        if (this.textarea) this.textarea.classList.remove('speech-active');
                        break;
                }
            },
            
            updateStatus(message) {
                if (!this.statusEl || !this.isListening) return;
                
                // Behoud audio bars tijdens luisteren
                if (this.isListening) {
                    this.statusEl.innerHTML = '<span class="audio-bars"><span class="audio-bar"></span><span class="audio-bar"></span><span class="audio-bar"></span><span class="audio-bar"></span><span class="audio-bar"></span></span> ' + message;
                }
            },
            
            showUnsupported() {
                const btn = $('#speechBtn');
                const status = $('#speechStatus');
                if (btn) btn.style.display = 'none';
                if (status) status.textContent = 'Spraakherkenning niet ondersteund. Gebruik Chrome, Edge of Safari.';
            },
            
            start() {
                if (!this.recognition) {
                    showToast('Spraakherkenning niet beschikbaar', 'error');
                    return;
                }
                
                // Cache UI elements als nog niet gedaan
                if (!this.textarea) this.textarea = $('#omschrijvingInput');
                if (!this.statusEl) this.statusEl = $('#speechStatus');
                if (!this.buttonEl) this.buttonEl = $('#speechBtn');
                
                // Sla bestaande tekst op als base
                this.baseText = this.textarea.value.trim();
                
                // Reset session state
                this.confirmedText = '';
                this.pendingText = '';
                this.sessionBuffer = [];
                this.restartCount = 0;
                this.sessionStartTime = Date.now();
                this.lastResultTime = Date.now();
                this.shouldRestart = true;
                
                try {
                    this.recognition.start();
                    console.log('[Speech] Starting new session');
                } catch (e) {
                    if (e.message && e.message.includes('already started')) {
                        // Stop en start opnieuw
                        this.recognition.stop();
                        setTimeout(() => this.start(), 100);
                    } else {
                        console.error('[Speech] Start error:', e);
                        showToast('Kon spraakherkenning niet starten', 'error');
                    }
                }
            },
            
            stop() {
                console.log('[Speech] Manual stop requested');
                this.forceStop();
            },
            
            forceStop() {
                this.shouldRestart = false;
                this.isListening = false;
                
                try {
                    this.recognition.abort(); // abort is sneller dan stop
                } catch (e) {
                    // Ignore
                }
                
                // Zorg dat alle tekst bewaard blijft
                if (this.pendingText.trim()) {
                    if (!this.confirmedText.endsWith(this.pendingText.trim())) {
                        this.confirmedText = this.confirmedText.trim() + ' ' + this.pendingText.trim();
                    }
                    this.pendingText = '';
                    this.updateTextarea();
                }
                
                this.updateUI('stopped');
                
                // Log sessie statistieken
                const duration = Math.round((Date.now() - this.sessionStartTime) / 1000);
                console.log('[Speech] Session ended. Duration: ' + duration + 's, Restarts: ' + this.restartCount);
            },
            
            toggle() {
                if (this.isListening) {
                    this.stop();
                } else {
                    this.start();
                }
            }
        };
        
        // Backwards compatible functions
        function initSpeechRecognition() {
            SpeechEngine.init();
        }
        
        function toggleSpeechRecognition() {
            SpeechEngine.toggle();
        }
        
        function startSpeechRecognition() {
            SpeechEngine.start();
        }
        
        function stopSpeechRecognition() {
            SpeechEngine.stop();
        }
        
        // =====================================================
        // AUTOCOMPLETE STRAATNAMEN
        // =====================================================
        function initStraatnamenAutocomplete() {
            const input = $('#straatnaamInput');
            const list = $('#straatnaamList');
            let activeIndex = -1;
            
            input.addEventListener('input', () => {
                const value = input.value.toLowerCase();
                list.innerHTML = '';
                activeIndex = -1;
                
                if (value.length < 2) {
                    list.classList.remove('show');
                    return;
                }
                
                const matches = STRAATNAMEN_HILVERSUM.filter(s => 
                    s.toLowerCase().includes(value)
                ).slice(0, 10);
                
                if (matches.length === 0) {
                    list.classList.remove('show');
                    return;
                }
                
                matches.forEach((straat, index) => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.textContent = straat;
                    item.addEventListener('click', () => {
                        input.value = straat;
                        list.classList.remove('show');
                        $('#huisnummerInput').focus();
                    });
                    list.appendChild(item);
                });
                
                list.classList.add('show');
            });
            
            input.addEventListener('keydown', (e) => {
                const items = list.querySelectorAll('.autocomplete-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    activeIndex = Math.min(activeIndex + 1, items.length - 1);
                    updateActiveItem(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    activeIndex = Math.max(activeIndex - 1, 0);
                    updateActiveItem(items);
                } else if (e.key === 'Enter' && activeIndex >= 0) {
                    e.preventDefault();
                    items[activeIndex].click();
                } else if (e.key === 'Escape') {
                    list.classList.remove('show');
                }
            });
            
            function updateActiveItem(items) {
                items.forEach((item, index) => {
                    item.classList.toggle('active', index === activeIndex);
                });
            }
            
            // Close on click outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.autocomplete-container')) {
                    list.classList.remove('show');
                }
            });
        }
        
        // =====================================================
        // BEDRIJVEN MANAGEMENT
        // =====================================================
        // Render dropdowns voor nieuwe melding scherm
        function renderEntityDropdowns() {
            // Bedrijven dropdown
            const bedrijfSelect = $('#bedrijfSelect');
            const bedrijven = getBedrijven();
            bedrijfSelect.innerHTML = '<option value="">-- Selecteer bedrijf --</option>';
            bedrijven.forEach(b => {
                bedrijfSelect.innerHTML += `<option value="${b}">${b}</option>`;
            });
            
            // Locaties dropdown
            const locatieSelect = $('#locatieSelect');
            const locaties = getLocaties();
            locatieSelect.innerHTML = '<option value="">-- Selecteer locatie --</option>';
            locaties.forEach(l => {
                const display = l.adres ? `${l.naam} (${l.adres})` : l.naam;
                locatieSelect.innerHTML += `<option value="${l.id}">${display}</option>`;
            });
            
            // Zorgverleners dropdown
            const zvSelect = $('#zorgverlenerSelect');
            const zorgverleners = getZorgverleners();
            zvSelect.innerHTML = '<option value="">-- Selecteer zorgverlener --</option>';
            zorgverleners.forEach(zv => {
                const zzpTag = zv.isZzp ? ' (ZZP)' : '';
                const functieTag = zv.functie ? ` - ${zv.functie}` : '';
                zvSelect.innerHTML += `<option value="${zv.id}">${zv.naam}${functieTag}${zzpTag}</option>`;
            });
        }
        
        // Render settings lijsten
        function renderSettingsLists() {
            // Bedrijven
            const bedrijvenSelect = $('#bedrijvenBeheerSelect');
            const bedrijven = getBedrijven();
            bedrijvenSelect.innerHTML = '';
            if (bedrijven.length === 0) {
                bedrijvenSelect.innerHTML = '<option disabled>Geen bedrijven</option>';
            } else {
                bedrijven.forEach(b => {
                    bedrijvenSelect.innerHTML += `<option value="${b}">${b}</option>`;
                });
            }
            
            // Locaties
            const locatiesSelect = $('#locatiesBeheerSelect');
            const locaties = getLocaties();
            locatiesSelect.innerHTML = '';
            if (locaties.length === 0) {
                locatiesSelect.innerHTML = '<option disabled>Geen locaties</option>';
            } else {
                locaties.forEach(l => {
                    const display = l.adres ? `${l.naam} - ${l.adres}` : l.naam;
                    locatiesSelect.innerHTML += `<option value="${l.id}">${display}</option>`;
                });
            }
            
            // Zorgverleners
            const zvSelect = $('#zorgverlenersBeheerSelect');
            const zorgverleners = getZorgverleners();
            zvSelect.innerHTML = '';
            if (zorgverleners.length === 0) {
                zvSelect.innerHTML = '<option disabled>Geen zorgverleners</option>';
            } else {
                zorgverleners.forEach(zv => {
                    const zzpTag = zv.isZzp ? ' (ZZP)' : '';
                    const functieTag = zv.functie ? ` - ${zv.functie}` : '';
                    zvSelect.innerHTML += `<option value="${zv.id}">${zv.naam}${functieTag}${zzpTag}</option>`;
                });
            }
        }
        
        // Filter meldingen op zoekterm
        function filterMeldingen() {
            var zoekInput = document.getElementById('meldingenZoek');
            var zoekterm = zoekInput ? zoekInput.value.toLowerCase().trim() : '';
            renderAlleMeldingen(zoekterm);
        }
        
        // =====================================================
        // PIN & AUTHENTICATION
        // =====================================================
        function initPIN() {
            const user = getUser();
            const pin = getPin();
            
            if (!user || !pin) {
                // Show setup
                $('#pinLogin').classList.add('hidden');
                $('#pinSetup').classList.remove('hidden');
            } else {
                // Show login
                APP.currentUser = user;
                $('#pinLogin').classList.remove('hidden');
                $('#pinSetup').classList.add('hidden');
            }
        }
        
        function handlePinKey(key) {
            const dots = $$('#pinDots .pin-dot');
            const error = $('#pinError');
            
            if (key === 'back') {
                APP.currentPin = APP.currentPin.slice(0, -1);
            } else if (APP.currentPin.length < 4) {
                APP.currentPin += key;
            }
            
            // Update dots
            dots.forEach((dot, i) => {
                dot.classList.toggle('filled', i < APP.currentPin.length);
            });
            
            // Check PIN when 4 digits entered
            if (APP.currentPin.length === 4) {
                setTimeout(() => {
                    if (APP.currentPin === getPin()) {
                        loginSuccess();
                    } else {
                        error.textContent = 'Onjuiste PIN, probeer opnieuw';
                        APP.currentPin = '';
                        dots.forEach(dot => dot.classList.remove('filled'));
                        
                        // Shake animation
                        $('#pinDots').style.animation = 'shake 0.3s';
                        setTimeout(() => $('#pinDots').style.animation = '', 300);
                    }
                }, 200);
            } else {
                error.textContent = '';
            }
        }
        
        function handleSetup() {
            const name = $('#setupName').value.trim();
            const pin = $('#setupPin').value;
            const pinConfirm = $('#setupPinConfirm').value;
            const werkgeverType = $('#setupWerkgeverType').value;
            const error = $('#setupError');
            
            if (!name) {
                error.textContent = 'Vul uw naam in';
                return;
            }
            
            if (!werkgeverType) {
                error.textContent = 'Selecteer werkgever type';
                return;
            }
            
            // Check gemeente of zorgkantoor
            let gemeente = '';
            let zorgkantoor = '';
            
            if (werkgeverType === 'gemeente') {
                gemeente = $('#setupGemeente').value;
                if (!gemeente) {
                    error.textContent = 'Selecteer een gemeente';
                    return;
                }
                if (gemeente === 'Anders') {
                    gemeente = $('#setupGemeenteAnders').value.trim();
                    if (!gemeente) {
                        error.textContent = 'Vul de gemeentenaam in';
                        return;
                    }
                }
            } else if (werkgeverType === 'zorgkantoor') {
                zorgkantoor = $('#setupZorgkantoor').value;
                if (!zorgkantoor) {
                    error.textContent = 'Selecteer een zorgkantoor';
                    return;
                }
                if (zorgkantoor === 'Anders') {
                    zorgkantoor = $('#setupZorgkantoorAnders').value.trim();
                    if (!zorgkantoor) {
                        error.textContent = 'Vul de zorgkantoor naam in';
                        return;
                    }
                }
            }
            
            if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                error.textContent = 'PIN moet 4 cijfers zijn';
                return;
            }
            
            if (pin !== pinConfirm) {
                error.textContent = 'PIN codes komen niet overeen';
                return;
            }
            
            // Save user met werkgever info
            const user = { 
                name, 
                werkgeverType,
                gemeente,
                zorgkantoor,
                createdAt: new Date().toISOString() 
            };
            saveUser(user);
            savePin(pin);
            APP.currentUser = user;
            
            loginSuccess();
        }
        
        // Toggle functies voor werkgever selectie
        function toggleWerkgeverDetails() {
            const type = $('#setupWerkgeverType').value;
            $('#gemeenteSelectDiv').style.display = type === 'gemeente' ? 'block' : 'none';
            $('#zorgkantoorSelectDiv').style.display = type === 'zorgkantoor' ? 'block' : 'none';
        }
        
        function toggleGemeenteAnders() {
            const val = $('#setupGemeente').value;
            $('#setupGemeenteAnders').style.display = val === 'Anders' ? 'block' : 'none';
        }
        
        function toggleZorgkantoorAnders() {
            const val = $('#setupZorgkantoor').value;
            $('#setupZorgkantoorAnders').style.display = val === 'Anders' ? 'block' : 'none';
        }
        
        function loginSuccess() {
            $('#pinScreen').classList.remove('active');
            $('#mainApp').classList.remove('hidden');
            
            // Update UI
            $('#userName').textContent = APP.currentUser.name;
            $('#settingsName').value = APP.currentUser.name;
            
            // Update werkgever display
            const werkgever = APP.currentUser.gemeente || APP.currentUser.zorgkantoor || '';
            if (werkgever) {
                $('#headerWerkgever').textContent = werkgever + ' - ' + APP.currentUser.name;
                $('#settingsWerkgever').value = (APP.currentUser.werkgeverType === 'gemeente' ? 'Gemeente ' : '') + werkgever;
            }
            
            // Initialize app
            initGPS();
            initSpeechRecognition();
            initStraatnamenAutocomplete();
            renderEntityDropdowns();
            renderSettingsLists();
            updateDashboard();
        }
        
        function logout() {
            APP.currentPin = '';
            APP.selectedBedrijven = [];
            
            if (APP.gpsWatchId) {
                navigator.geolocation.clearWatch(APP.gpsWatchId);
            }
            
            $('#mainApp').classList.add('hidden');
            $('#pinScreen').classList.add('active');
            
            // Reset PIN dots
            $$('#pinDots .pin-dot').forEach(dot => dot.classList.remove('filled'));
            $('#pinError').textContent = '';
        }
        
        // =====================================================
        // MELDINGEN
        // =====================================================
        function saveMelding() {
            const straatnaam = $('#straatnaamInput').value.trim();
            const huisnummer = $('#huisnummerInput').value.trim();
            const toevoeging = $('#toevoegingInput').value.trim();
            const typeZorgverlening = $('#typeZorgverlening').value;
            const typeCriminaliteit = $('#typeCriminaliteit').value;
            const omschrijving = $('#omschrijvingInput').value.trim();
            
            // Entiteiten uit dropdowns
            const bedrijfSelect = $('#bedrijfSelect').value;
            const locatieSelect = $('#locatieSelect').value;
            const zorgverlenerSelect = $('#zorgverlenerSelect').value;
            
            // Validation
            if (!straatnaam) {
                showToast('Vul een straatnaam in', 'error');
                return;
            }
            
            if (!huisnummer) {
                showToast('Vul een huisnummer in', 'error');
                return;
            }
            
            if (!typeZorgverlening) {
                showToast('Selecteer type zorgverlening', 'error');
                return;
            }
            
            if (!typeCriminaliteit) {
                showToast('Selecteer type zorgcriminaliteit', 'error');
                return;
            }
            
            if (!omschrijving) {
                showToast('Vul een omschrijving in', 'error');
                return;
            }
            
            // Build address
            let adres = straatnaam + ' ' + huisnummer;
            if (toevoeging) adres += toevoeging;
            
            // Haal gemeente uit user settings
            const werkgever = APP.currentUser.gemeente || APP.currentUser.zorgkantoor || 'Onbekend';
            adres += ', ' + (APP.currentUser.gemeente || 'Onbekend');
            
            // Haal entiteit namen op
            let locatieNaam = '';
            if (locatieSelect) {
                const loc = getLocaties().find(l => l.id === locatieSelect);
                if (loc) locatieNaam = loc.naam;
            }
            
            let zorgverlenerNaam = '';
            let zorgverlenerIsZzp = false;
            if (zorgverlenerSelect) {
                const zv = getZorgverleners().find(z => z.id === zorgverlenerSelect);
                if (zv) {
                    zorgverlenerNaam = zv.naam;
                    zorgverlenerIsZzp = zv.isZzp;
                }
            }
            
            // Create melding object
            const melding = {
                id: generateId(),
                datum: new Date().toISOString(),
                melder: APP.currentUser.name,
                consulent: APP.currentUser.name,
                werkgeverType: APP.currentUser.werkgeverType || '',
                werkgever: werkgever,
                // Entiteiten
                bedrijf: bedrijfSelect,
                bedrijven: bedrijfSelect ? [bedrijfSelect] : [],
                locatieId: locatieSelect,
                locatieNaam: locatieNaam,
                zorgverlenerId: zorgverlenerSelect,
                zorgverlenerNaam: zorgverlenerNaam,
                zorgverlenerIsZzp: zorgverlenerIsZzp,
                // Adres
                adres: adres,
                straatnaam: straatnaam,
                huisnummer: huisnummer,
                toevoeging: toevoeging,
                gemeente: APP.currentUser.gemeente || '',
                // Classificatie
                typeZorgverlening: typeZorgverlening,
                typeZorgverleningLabel: $('#typeZorgverlening option:checked').textContent,
                typeCriminaliteit: typeCriminaliteit,
                typeCriminaliteitLabel: $('#typeCriminaliteit option:checked').textContent,
                omschrijving: omschrijving,
                gps: APP.gpsPosition ? { ...APP.gpsPosition } : null
            };
            
            // Save
            const meldingen = getMeldingen();
            meldingen.unshift(melding);
            saveMeldingen(meldingen);
            
            // Reset form
            resetMeldingForm();
            
            // Update UI
            updateDashboard();
            showToast('Melding opgeslagen!', 'success');
            
            // Switch to dashboard
            switchScreen('dashboard');
        }
        
        function resetMeldingForm() {
            $('#straatnaamInput').value = '';
            $('#huisnummerInput').value = '';
            $('#toevoegingInput').value = '';
            $('#typeZorgverlening').value = '';
            $('#typeCriminaliteit').value = '';
            $('#omschrijvingInput').value = '';
            // Reset dropdowns
            $('#bedrijfSelect').value = '';
            $('#locatieSelect').value = '';
            $('#zorgverlenerSelect').value = '';
            $('#zorgverlenerIsZzp').checked = false;
            // Reset input velden
            $('#nieuwBedrijfInput').value = '';
            $('#nieuwLocatieInput').value = '';
            $('#nieuwZorgverlenerInput').value = '';
        }
        
        function updateDashboard() {
            const meldingen = getMeldingen();
            const bedrijven = getBedrijven();
            const locaties = getLocaties();
            const zorgverleners = getZorgverleners();
            
            // Stats alleen
            $('#statMeldingen').textContent = meldingen.length;
            $('#statBedrijven').textContent = bedrijven.length + locaties.length + zorgverleners.length;
        }
        
        function renderAlleMeldingen(zoekterm = '') {
            const allContainer = document.getElementById('alleMeldingen');
            const countDiv = document.getElementById('meldingenCount');
            
            if (!allContainer) {
                console.error('alleMeldingen container niet gevonden');
                return;
            }
            
            // Haal meldingen op
            let meldingen = [];
            try {
                const data = localStorage.getItem('zorganalyst_meldingen');
                if (data) {
                    meldingen = JSON.parse(data);
                }
            } catch (e) {
                console.error('Fout bij ophalen meldingen:', e);
                meldingen = [];
            }
            
            const totalCount = meldingen.length;
            
            // Update count altijd eerst
            if (countDiv) {
                countDiv.textContent = totalCount + ' meldingen';
            }
            
            // Check of er meldingen zijn
            if (totalCount === 0) {
                allContainer.innerHTML = '<p style="color: var(--secondary); text-align: center; padding: 20px 0;">Nog geen meldingen</p>';
                return;
            }
            
            // Filter op zoekterm indien nodig
            if (zoekterm && zoekterm.trim() !== '') {
                const zoektermLower = zoekterm.toLowerCase();
                meldingen = meldingen.filter(function(m) {
                    const searchText = [
                        m.adres || '',
                        m.omschrijving || '',
                        m.typeCriminaliteitLabel || m.typeCriminaliteit || '',
                        m.typeZorgverleningLabel || m.typeZorgverlening || '',
                        m.bedrijf || '',
                        m.locatieNaam || '',
                        m.zorgverlenerNaam || '',
                        (m.bedrijven || []).join(' ')
                    ].join(' ').toLowerCase();
                    return searchText.indexOf(zoektermLower) !== -1;
                });
                
                if (countDiv) {
                    countDiv.textContent = meldingen.length + ' van ' + totalCount + ' meldingen';
                }
            }
            
            // Check na filtering
            if (meldingen.length === 0) {
                allContainer.innerHTML = '<p style="color: var(--secondary); text-align: center; padding: 20px 0;">Geen meldingen gevonden</p>';
                return;
            }
            
            // Bouw HTML
            var html = '';
            for (var i = 0; i < meldingen.length; i++) {
                var m = meldingen[i];
                var bedrijfInfo = m.bedrijf || (m.bedrijven && m.bedrijven.length > 0 ? m.bedrijven.join(', ') : '');
                var omschrijving = m.omschrijving || '';
                var shortOmschrijving = omschrijving.length > 80 ? omschrijving.substring(0, 80) + '...' : omschrijving;
                var datumStr = '';
                try {
                    datumStr = formatDate(m.datum);
                } catch(e) {
                    datumStr = m.datum || '';
                }
                
                html += '<div class="melding-card" data-index="' + i + '">';
                html += '<div class="melding-card-header" onclick="toggleMelding(' + i + ')">';
                html += '<div class="melding-card-top">';
                html += '<span class="melding-type">' + (m.typeCriminaliteitLabel || m.typeCriminaliteit || 'Onbekend') + '</span>';
                html += '<span class="melding-date">' + datumStr + '</span>';
                html += '</div>';
                if (bedrijfInfo) {
                    html += '<div class="melding-bedrijf"><strong>' + bedrijfInfo + '</strong></div>';
                }
                html += '<div class="melding-adres"><i class="fas fa-map-marker-alt"></i> ' + (m.adres || 'Geen adres') + '</div>';
                html += '<div class="melding-preview">' + shortOmschrijving + '</div>';
                html += '<div class="melding-toggle" id="toggle' + i + '"><i class="fas fa-chevron-down"></i> Tik voor details</div>';
                html += '</div>';
                
                html += '<div class="melding-card-body" id="meldingBody' + i + '" style="display:none;">';
                html += '<div class="melding-details-inner">';
                if (m.typeZorgverleningLabel) {
                    html += '<p><strong>Type zorg:</strong> ' + m.typeZorgverleningLabel + '</p>';
                }
                if (bedrijfInfo) {
                    html += '<p><strong>Bedrijf:</strong> ' + bedrijfInfo + '</p>';
                }
                if (m.locatieNaam) {
                    html += '<p><strong>Locatie:</strong> ' + m.locatieNaam + '</p>';
                }
                if (m.zorgverlenerNaam) {
                    html += '<p><strong>Zorgverlener:</strong> ' + m.zorgverlenerNaam + (m.zorgverlenerIsZzp ? ' (ZZP)' : '') + '</p>';
                }
                if (m.gps && m.gps.lat && m.gps.lng) {
                    html += '<p><strong>GPS:</strong> ' + m.gps.lat.toFixed(6) + ', ' + m.gps.lng.toFixed(6) + '</p>';
                }
                html += '<p><strong>Volledige melding:</strong></p>';
                html += '<div class="melding-full-text">' + omschrijving + '</div>';
                html += '</div></div></div>';
            }
            
            allContainer.innerHTML = html;
        }
        
        // Toggle functie voor uitklappen
        function toggleMelding(index) {
            var body = document.getElementById('meldingBody' + index);
            var toggle = document.getElementById('toggle' + index);
            
            if (!body || !toggle) {
                console.error('Melding elementen niet gevonden voor index:', index);
                return;
            }
            
            if (body.style.display === 'none' || body.style.display === '') {
                body.style.display = 'block';
                toggle.innerHTML = '<i class="fas fa-chevron-up"></i> Inklappen';
            } else {
                body.style.display = 'none';
                toggle.innerHTML = '<i class="fas fa-chevron-down"></i> Tik voor details';
            }
        }
        
        // =====================================================
        // EXPORT
        // =====================================================
        function exportJSON() {
            const meldingen = getMeldingen();
            const user = getUser();
            const bedrijven = getBedrijven();
            const locaties = getLocaties();
            const zorgverleners = getZorgverleners();
            
            if (meldingen.length === 0) {
                showToast('Geen meldingen om te exporteren', 'error');
                return;
            }
            
            const werkgever = user.gemeente || user.zorgkantoor || '';
            
            const exportData = {
                exportInfo: {
                    applicatie: 'ZorgAnalyst Pro Mobile',
                    versie: '2.1.0',
                    exportDatum: new Date().toISOString(),
                    melder: user.name,
                    consulent: user.name,
                    werkgeverType: user.werkgeverType || '',
                    gemeente: user.gemeente || '',
                    zorgkantoor: user.zorgkantoor || '',
                    aantalMeldingen: meldingen.length
                },
                entiteiten: {
                    bedrijven: bedrijven,
                    locaties: locaties,
                    zorgverleners: zorgverleners
                },
                meldingen: meldingen.map(m => ({
                    ...m,
                    exportMelder: user.name,
                    exportConsulent: user.name,
                    exportGemeente: werkgever
                }))
            };
            
            const json = JSON.stringify(exportData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            const timestamp = new Date().toISOString().slice(0, 10);
            const safeName = user.name.replace(/[^a-zA-Z0-9]/g, '_');
            const safeWerkgever = werkgever.replace(/[^a-zA-Z0-9]/g, '_');
            a.href = url;
            a.download = `zorganalyst_${safeWerkgever}_${safeName}_${timestamp}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast(`${meldingen.length} meldingen geëxporteerd`, 'success');
        }
        
        // =====================================================
        // NAVIGATION
        // =====================================================
        function switchScreen(screenName) {
            // Update screens
            $$('.screen').forEach(s => s.classList.remove('active'));
            $(`#${screenName}Screen`).classList.add('active');
            
            // Update nav
            $$('.nav-item').forEach(n => n.classList.remove('active'));
            $(`.nav-item[data-screen="${screenName}"]`).classList.add('active');
            
            // Special actions
            if (screenName === 'nieuw') {
                updateGPSInfo();
                renderEntityDropdowns();
            } else if (screenName === 'instellingen') {
                renderSettingsLists();
            } else if (screenName === 'meldingen') {
                renderAlleMeldingen();
            }
        }
        
        // =====================================================
        // EVENT LISTENERS
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize PIN
            initPIN();
            
            // PIN keypad
            $$('.pin-key').forEach(key => {
                key.addEventListener('click', () => {
                    const keyVal = key.dataset.key;
                    if (keyVal) handlePinKey(keyVal);
                });
            });
            
            // Setup form
            $('#setupSubmit').addEventListener('click', handleSetup);
            
            // Navigation
            $$('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    switchScreen(item.dataset.screen);
                });
            });
            
            // Add bedrijf (melding form)
            $('#addBedrijfBtn').addEventListener('click', () => {
                const input = $('#nieuwBedrijfInput');
                if (addBedrijf(input.value)) {
                    // Selecteer direct in dropdown
                    const newVal = input.value.trim();
                    input.value = '';
                    renderEntityDropdowns();
                    $('#bedrijfSelect').value = newVal;
                    showToast('Bedrijf toegevoegd');
                } else if (input.value.trim()) {
                    showToast('Bedrijf bestaat al', 'error');
                }
            });
            
            // Add locatie (melding form)
            $('#addLocatieBtn').addEventListener('click', () => {
                const input = $('#nieuwLocatieInput');
                const result = addLocatie({ naam: input.value });
                if (result) {
                    input.value = '';
                    renderEntityDropdowns();
                    $('#locatieSelect').value = result.id;
                    showToast('Locatie toegevoegd');
                } else if (input.value.trim()) {
                    showToast('Locatie bestaat al', 'error');
                }
            });
            
            // Add zorgverlener (melding form)
            $('#addZorgverlenerBtn').addEventListener('click', () => {
                const input = $('#nieuwZorgverlenerInput');
                const isZzp = $('#zorgverlenerIsZzp').checked;
                const result = addZorgverlener({ naam: input.value, isZzp: isZzp });
                if (result) {
                    input.value = '';
                    $('#zorgverlenerIsZzp').checked = false;
                    renderEntityDropdowns();
                    $('#zorgverlenerSelect').value = result.id;
                    showToast('Zorgverlener toegevoegd');
                } else if (input.value.trim()) {
                    showToast('Zorgverlener bestaat al', 'error');
                }
            });
            
            // Add bedrijf (settings)
            $('#addBedrijfSettingsBtn').addEventListener('click', () => {
                const input = $('#nieuwBedrijfSettings');
                if (addBedrijf(input.value)) {
                    input.value = '';
                    renderSettingsLists();
                    renderEntityDropdowns();
                    showToast('Bedrijf toegevoegd');
                } else if (input.value.trim()) {
                    showToast('Bedrijf bestaat al', 'error');
                }
            });
            
            // Add locatie (settings)
            $('#addLocatieSettingsBtn').addEventListener('click', () => {
                const naam = $('#nieuwLocatieSettings').value.trim();
                const adres = $('#nieuwLocatieAdresSettings').value.trim();
                const result = addLocatie({ naam: naam, adres: adres });
                if (result) {
                    $('#nieuwLocatieSettings').value = '';
                    $('#nieuwLocatieAdresSettings').value = '';
                    renderSettingsLists();
                    renderEntityDropdowns();
                    showToast('Locatie toegevoegd');
                } else if (naam) {
                    showToast('Locatie bestaat al', 'error');
                }
            });
            
            // Add zorgverlener (settings)
            $('#addZorgverlenerSettingsBtn').addEventListener('click', () => {
                const naam = $('#nieuwZorgverlenerSettings').value.trim();
                const functie = $('#nieuwZvFunctieSettings').value.trim();
                const isZzp = $('#nieuwZvIsZzpSettings').checked;
                const result = addZorgverlener({ naam: naam, functie: functie, isZzp: isZzp });
                if (result) {
                    $('#nieuwZorgverlenerSettings').value = '';
                    $('#nieuwZvFunctieSettings').value = '';
                    $('#nieuwZvIsZzpSettings').checked = false;
                    renderSettingsLists();
                    renderEntityDropdowns();
                    showToast('Zorgverlener toegevoegd');
                } else if (naam) {
                    showToast('Zorgverlener bestaat al', 'error');
                }
            });
            
            // Delete buttons (settings)
            $('#deleteBedrijfBtn').addEventListener('click', () => {
                const select = $('#bedrijvenBeheerSelect');
                if (select.value && !select.selectedOptions[0].disabled) {
                    if (confirm(`Bedrijf "${select.value}" verwijderen?`)) {
                        removeBedrijf(select.value);
                        renderSettingsLists();
                        renderEntityDropdowns();
                        showToast('Bedrijf verwijderd');
                    }
                }
            });
            
            $('#deleteLocatieBtn').addEventListener('click', () => {
                const select = $('#locatiesBeheerSelect');
                if (select.value && !select.selectedOptions[0].disabled) {
                    const loc = getLocaties().find(l => l.id === select.value);
                    if (confirm(`Locatie "${loc?.naam || select.value}" verwijderen?`)) {
                        removeLocatie(select.value);
                        renderSettingsLists();
                        renderEntityDropdowns();
                        showToast('Locatie verwijderd');
                    }
                }
            });
            
            $('#deleteZorgverlenerBtn').addEventListener('click', () => {
                const select = $('#zorgverlenersBeheerSelect');
                if (select.value && !select.selectedOptions[0].disabled) {
                    const zv = getZorgverleners().find(z => z.id === select.value);
                    if (confirm(`Zorgverlener "${zv?.naam || select.value}" verwijderen?`)) {
                        removeZorgverlener(select.value);
                        renderSettingsLists();
                        renderEntityDropdowns();
                        showToast('Zorgverlener verwijderd');
                    }
                }
            });
            
            // Enter key for bedrijf inputs
            $('#nieuwBedrijfInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') $('#addBedrijfBtn').click();
            });
            
            $('#nieuwBedrijfSettings').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') $('#addBedrijfSettingsBtn').click();
            });
            
            // Speech button
            $('#speechBtn').addEventListener('click', toggleSpeechRecognition);
            
            // Save melding
            $('#saveMeldingBtn').addEventListener('click', saveMelding);
            
            // Save profile
            $('#saveProfileBtn').addEventListener('click', () => {
                const name = $('#settingsName').value.trim();
                if (!name) {
                    showToast('Vul een naam in', 'error');
                    return;
                }
                APP.currentUser.name = name;
                saveUser(APP.currentUser);
                $('#userName').textContent = name;
                showToast('Profiel opgeslagen', 'success');
            });
            
            // Export
            $('#exportJsonBtn').addEventListener('click', exportJSON);
            
            // Logout
            $('#logoutBtn').addEventListener('click', () => {
                if (confirm('Weet u zeker dat u wilt uitloggen?')) {
                    logout();
                }
            });
            
            // Change PIN
            $('#changePinBtn').addEventListener('click', () => {
                const currentPin = prompt('Huidige PIN:');
                if (currentPin !== getPin()) {
                    showToast('Onjuiste PIN', 'error');
                    return;
                }
                
                const newPin = prompt('Nieuwe PIN (4 cijfers):');
                if (!newPin || !/^\d{4}$/.test(newPin)) {
                    showToast('PIN moet 4 cijfers zijn', 'error');
                    return;
                }
                
                const confirmPin = prompt('Bevestig nieuwe PIN:');
                if (newPin !== confirmPin) {
                    showToast('PINs komen niet overeen', 'error');
                    return;
                }
                
                savePin(newPin);
                showToast('PIN gewijzigd', 'success');
            });
        });
        
        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => {
                console.log('SW registration failed:', err);
            });
        }
    </script>
</body>
</html>
