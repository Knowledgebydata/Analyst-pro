<!DOCTYPE html>
<!--
================================================================================
Declaratie Module - Declaraties voor Knowledge by Data Medewerkers
Versie: 1.0.0 PWA | Knowledge by Data
================================================================================

Copyright (c) 2025 L.P. Antenbrink, Knowledge by Data. Alle rechten voorbehouden.

DECLARATIE MODULE VOOR MEDEWERKERS
Functies:
- Kilometervergoeding declareren
- Uren declareren (€75/uur, €300/dagdeel, €500/dag)
- Categorieën: Instructie, Reistijd, Demo
- Export naar PDF/CSV

VERTROUWELIJK - UITSLUITEND VOOR GEAUTORISEERD GEBRUIK
================================================================================
-->
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="author" content="L.P. Antenbrink, Knowledge by Data">
<meta name="application-name" content="Declaratie Module">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#9c27b0">
<meta name="description" content="Declaraties indienen voor Knowledge by Data">
<title>Declaratie Module - Knowledge by Data</title>
<link rel="manifest" href="./manifest.json">
<link rel="apple-touch-icon" sizes="180x180" href="./icons/icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="./icons/icon-96x96.png">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
:root {
    --primary: #9c27b0;
    --primary-dark: #7b1fa2;
    --primary-light: #ce93d8;
    --accent: #00bcd4;
    --accent-light: #4dd0e1;
    --success: #4caf50;
    --warning: #ff9800;
    --danger: #f44336;
    --dark: #1a1a2e;
    --light: #f5f5f5;
    --gray: #757575;
    --gray-light: #e0e0e0;
    --white: #ffffff;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--light);
    min-height: 100vh;
    color: var(--dark);
}

.security-bar {
    background: var(--primary);
    color: white;
    padding: 8px 15px;
    font-size: 0.75rem;
    text-align: center;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
}

.app-header {
    background: linear-gradient(135deg, var(--dark), #16213e);
    color: white;
    padding: 20px;
    padding-top: 50px;
    text-align: center;
}

.app-header h1 {
    font-size: 1.4rem;
    color: var(--primary-light);
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.app-header p {
    color: var(--gray);
    font-size: 0.85rem;
}

.nav-tabs {
    display: flex;
    background: white;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    position: sticky;
    top: 30px;
    z-index: 100;
}

.nav-tab {
    flex: 1;
    padding: 15px 10px;
    text-align: center;
    border: none;
    background: none;
    cursor: pointer;
    font-size: 0.8rem;
    color: var(--gray);
    transition: all 0.3s;
    border-bottom: 3px solid transparent;
}

.nav-tab.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
    background: rgba(156, 39, 176, 0.05);
}

.nav-tab i {
    display: block;
    font-size: 1.2rem;
    margin-bottom: 4px;
}

.main-content {
    padding: 15px;
    padding-bottom: 100px;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.card {
    background: white;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--gray-light);
}

.card-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.card-title i {
    color: var(--primary);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 20px;
}

.stat-card {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 16px;
    border-radius: 12px;
    text-align: center;
}

.stat-card.accent {
    background: linear-gradient(135deg, var(--accent), #0097a7);
}

.stat-card.success {
    background: linear-gradient(135deg, var(--success), #388e3c);
}

.stat-card.warning {
    background: linear-gradient(135deg, var(--warning), #f57c00);
}

.stat-number {
    font-size: 1.5rem;
    font-weight: bold;
}

.stat-label {
    font-size: 0.7rem;
    opacity: 0.9;
    margin-top: 2px;
}

.form-group {
    margin-bottom: 16px;
}

.form-label {
    display: block;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 6px;
}

.form-control {
    width: 100%;
    padding: 12px 14px;
    border: 2px solid var(--gray-light);
    border-radius: 10px;
    font-size: 1rem;
    transition: border-color 0.3s;
    background: white;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary);
}

select.form-control {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23757575' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 14px center;
    padding-right: 40px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.form-hint {
    font-size: 0.75rem;
    color: var(--gray);
    margin-top: 4px;
}

/* Rate Cards */
.rate-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 16px;
}

.rate-card {
    padding: 15px 10px;
    border: 2px solid var(--gray-light);
    border-radius: 12px;
    background: white;
    cursor: pointer;
    text-align: center;
    transition: all 0.2s;
}

.rate-card:hover {
    border-color: var(--primary);
    background: rgba(156, 39, 176, 0.05);
}

.rate-card.active {
    border-color: var(--primary);
    background: var(--primary);
    color: white;
}

.rate-card .rate-amount {
    font-size: 1.2rem;
    font-weight: bold;
    margin-bottom: 4px;
}

.rate-card .rate-label {
    font-size: 0.75rem;
    opacity: 0.8;
}

/* Category Pills */
.category-pills {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 16px;
}

.category-pill {
    padding: 10px 16px;
    border: 2px solid var(--gray-light);
    border-radius: 20px;
    background: white;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
}

.category-pill:hover {
    border-color: var(--primary);
}

.category-pill.active {
    border-color: var(--primary);
    background: var(--primary);
    color: white;
}

.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 20px;
    border-radius: 10px;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all 0.3s;
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-dark);
}

.btn-accent {
    background: var(--accent);
    color: white;
}

.btn-success {
    background: var(--success);
    color: white;
}

.btn-danger {
    background: var(--danger);
    color: white;
}

.btn-outline {
    background: transparent;
    border: 2px solid var(--primary);
    color: var(--primary);
}

.btn-block {
    width: 100%;
}

.btn-lg {
    padding: 16px 24px;
    font-size: 1.05rem;
}

/* Declaration List */
.declaration-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.declaration-item {
    background: var(--light);
    border-radius: 12px;
    padding: 14px;
    cursor: pointer;
    transition: all 0.2s;
    border-left: 4px solid var(--primary);
}

.declaration-item.km {
    border-left-color: var(--accent);
}

.declaration-item.hours {
    border-left-color: var(--primary);
}

.declaration-item:hover {
    background: var(--gray-light);
}

.declaration-item-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 6px;
}

.declaration-item-type {
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--dark);
}

.declaration-item-amount {
    background: var(--primary);
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 600;
}

.declaration-item-amount.km {
    background: var(--accent);
}

.declaration-item-meta {
    font-size: 0.8rem;
    color: var(--gray);
    display: flex;
    gap: 15px;
}

.declaration-item-category {
    font-size: 0.8rem;
    color: var(--primary);
    margin-top: 4px;
}

/* Info Box */
.info-box {
    background: rgba(156, 39, 176, 0.1);
    border-left: 4px solid var(--primary);
    padding: 12px 15px;
    border-radius: 0 8px 8px 0;
    font-size: 0.85rem;
    color: var(--dark);
    margin-bottom: 15px;
}

.info-box.accent {
    background: rgba(0, 188, 212, 0.1);
    border-left-color: var(--accent);
}

/* Totals Display */
.totals-display {
    background: linear-gradient(135deg, var(--dark), #16213e);
    color: white;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 15px;
}

.totals-display h3 {
    font-size: 0.9rem;
    margin-bottom: 15px;
    opacity: 0.9;
}

.totals-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.total-item {
    text-align: center;
}

.total-item .label {
    font-size: 0.75rem;
    opacity: 0.8;
    margin-bottom: 4px;
}

.total-item .value {
    font-size: 1.3rem;
    font-weight: bold;
}

.total-item.highlight .value {
    color: var(--primary-light);
}

/* Modal */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.modal-overlay.active {
    display: flex;
}

.modal {
    background: white;
    border-radius: 20px;
    width: 100%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid var(--gray-light);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    font-size: 1.1rem;
    color: var(--dark);
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--gray);
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    padding: 15px 20px;
    border-top: 1px solid var(--gray-light);
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

/* Toast */
.toast-container {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 2000;
}

.toast {
    background: var(--dark);
    color: white;
    padding: 12px 20px;
    border-radius: 10px;
    font-size: 0.9rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    animation: slideUp 0.3s ease;
    margin-top: 8px;
}

.toast.success { background: var(--success); }
.toast.error { background: var(--danger); }
.toast.warning { background: var(--warning); color: var(--dark); }

@keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--gray);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.3;
}

/* Status Badge */
.status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

.status-badge.pending {
    background: rgba(255, 152, 0, 0.2);
    color: #f57c00;
}

.status-badge.approved {
    background: rgba(76, 175, 80, 0.2);
    color: #388e3c;
}

.status-badge.rejected {
    background: rgba(244, 67, 54, 0.2);
    color: #d32f2f;
}

@media (max-width: 380px) {
    .nav-tab {
        padding: 12px 5px;
        font-size: 0.7rem;
    }
    
    .rate-grid {
        grid-template-columns: 1fr;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
}
</style>
</head>
<body>

<div class="security-bar">
    <i class="fas fa-euro-sign"></i> Declaratie Module - Knowledge by Data
</div>

<header class="app-header">
    <h1><i class="fas fa-file-invoice-dollar"></i> Declaratie Module</h1>
    <p>Declaraties indienen voor Knowledge by Data</p>
</header>

<nav class="nav-tabs">
    <button class="nav-tab active" data-tab="dashboard">
        <i class="fas fa-home"></i>
        Overzicht
    </button>
    <button class="nav-tab" data-tab="km">
        <i class="fas fa-car"></i>
        Kilometers
    </button>
    <button class="nav-tab" data-tab="hours">
        <i class="fas fa-clock"></i>
        Uren
    </button>
    <button class="nav-tab" data-tab="settings">
        <i class="fas fa-cog"></i>
        Instellingen
    </button>
</nav>

<main class="main-content">
    <!-- Dashboard Tab -->
    <div id="tab-dashboard" class="tab-content active">
        <div class="totals-display">
            <h3><i class="fas fa-chart-line"></i> Totaal te declareren</h3>
            <div class="totals-grid">
                <div class="total-item">
                    <div class="label">Kilometers</div>
                    <div class="value" id="total-km-amount">€ 0,00</div>
                </div>
                <div class="total-item">
                    <div class="label">Uren</div>
                    <div class="value" id="total-hours-amount">€ 0,00</div>
                </div>
                <div class="total-item highlight" style="grid-column: span 2;">
                    <div class="label">Totaal</div>
                    <div class="value" id="total-amount">€ 0,00</div>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card accent">
                <div class="stat-number" id="stat-km">0</div>
                <div class="stat-label">Kilometers</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-hours">0</div>
                <div class="stat-label">Uren gedeclareerd</div>
            </div>
            <div class="stat-card success">
                <div class="stat-number" id="stat-count">0</div>
                <div class="stat-label">Declaraties</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-number" id="stat-pending">0</div>
                <div class="stat-label">In behandeling</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span class="card-title"><i class="fas fa-list"></i> Recente Declaraties</span>
            </div>
            <div id="recent-declarations" class="declaration-list">
                <!-- Dynamic -->
            </div>
        </div>

        <div class="form-row">
            <button class="btn btn-accent btn-lg" onclick="switchTab('km')">
                <i class="fas fa-car"></i> KM
            </button>
            <button class="btn btn-primary btn-lg" onclick="switchTab('hours')">
                <i class="fas fa-clock"></i> Uren
            </button>
        </div>

        <button class="btn btn-success btn-block btn-lg" onclick="exportDeclarations()" style="margin-top: 15px;">
            <i class="fas fa-file-export"></i> Exporteer Declaraties
        </button>
    </div>

    <!-- KM Tab -->
    <div id="tab-km" class="tab-content">
        <div class="info-box accent">
            <strong>Kilometervergoeding:</strong> €0,23 per kilometer (onbelast)
        </div>

        <div class="card">
            <div class="card-header">
                <span class="card-title"><i class="fas fa-car"></i> Kilometervergoeding</span>
            </div>

            <div class="form-group">
                <label class="form-label">Datum</label>
                <input type="date" id="km-date" class="form-control">
            </div>

            <div class="form-group">
                <label class="form-label">Categorie *</label>
                <div class="category-pills" id="km-category-pills">
                    <button class="category-pill active" data-category="reistijd">
                        <i class="fas fa-car"></i> Reistijd
                    </button>
                    <button class="category-pill" data-category="instructie">
                        <i class="fas fa-chalkboard-teacher"></i> Instructie
                    </button>
                    <button class="category-pill" data-category="demo">
                        <i class="fas fa-desktop"></i> Demo
                    </button>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Van (plaats)</label>
                    <input type="text" id="km-from" class="form-control" placeholder="Bijv. Amsterdam">
                </div>
                <div class="form-group">
                    <label class="form-label">Naar (plaats)</label>
                    <input type="text" id="km-to" class="form-control" placeholder="Bijv. Rotterdam">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Aantal kilometers *</label>
                <input type="number" id="km-amount" class="form-control" placeholder="Bijv. 120" min="1" step="1">
            </div>

            <div class="form-group">
                <label class="form-label">Berekende vergoeding</label>
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent);" id="km-calculated">€ 0,00</div>
            </div>

            <div class="form-group">
                <label class="form-label">Omschrijving</label>
                <input type="text" id="km-description" class="form-control" placeholder="Bijv. Klantbezoek Gemeente X">
            </div>

            <button class="btn btn-accent btn-block btn-lg" onclick="saveKmDeclaration()">
                <i class="fas fa-save"></i> Opslaan
            </button>
        </div>
    </div>

    <!-- Hours Tab -->
    <div id="tab-hours" class="tab-content">
        <div class="info-box">
            <strong>Tarieven:</strong><br>
            • Per uur: €75<br>
            • Per dagdeel (4 uur): €300<br>
            • Per dag (8 uur): €500
        </div>

        <div class="card">
            <div class="card-header">
                <span class="card-title"><i class="fas fa-clock"></i> Uren Declareren</span>
            </div>

            <div class="form-group">
                <label class="form-label">Datum</label>
                <input type="date" id="hours-date" class="form-control">
            </div>

            <div class="form-group">
                <label class="form-label">Categorie *</label>
                <div class="category-pills" id="hours-category-pills">
                    <button class="category-pill active" data-category="instructie">
                        <i class="fas fa-chalkboard-teacher"></i> Instructie
                    </button>
                    <button class="category-pill" data-category="reistijd">
                        <i class="fas fa-car"></i> Reistijd
                    </button>
                    <button class="category-pill" data-category="demo">
                        <i class="fas fa-desktop"></i> Demo
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Tarief *</label>
                <div class="rate-grid" id="rate-grid">
                    <div class="rate-card" data-rate="hour" data-amount="75">
                        <div class="rate-amount">€75</div>
                        <div class="rate-label">per uur</div>
                    </div>
                    <div class="rate-card active" data-rate="halfday" data-amount="300">
                        <div class="rate-amount">€300</div>
                        <div class="rate-label">dagdeel</div>
                    </div>
                    <div class="rate-card" data-rate="fullday" data-amount="500">
                        <div class="rate-amount">€500</div>
                        <div class="rate-label">hele dag</div>
                    </div>
                </div>
            </div>

            <div class="form-group" id="hours-count-group">
                <label class="form-label">Aantal <span id="hours-unit-label">dagdelen</span></label>
                <input type="number" id="hours-count" class="form-control" value="1" min="1" step="1">
            </div>

            <div class="form-group">
                <label class="form-label">Totaalbedrag</label>
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);" id="hours-calculated">€ 300,00</div>
            </div>

            <div class="form-group">
                <label class="form-label">Project / Klant</label>
                <input type="text" id="hours-project" class="form-control" placeholder="Bijv. Training Gemeente X">
            </div>

            <div class="form-group">
                <label class="form-label">Omschrijving</label>
                <textarea id="hours-description" class="form-control" rows="2" placeholder="Wat heb je gedaan?"></textarea>
            </div>

            <button class="btn btn-primary btn-block btn-lg" onclick="saveHoursDeclaration()">
                <i class="fas fa-save"></i> Opslaan
            </button>
        </div>
    </div>

    <!-- Settings Tab -->
    <div id="tab-settings" class="tab-content">
        <div class="card">
            <div class="card-header">
                <span class="card-title"><i class="fas fa-user"></i> Medewerker Gegevens</span>
            </div>
            <div class="form-group">
                <label class="form-label">Naam</label>
                <input type="text" id="user-name" class="form-control" placeholder="Uw volledige naam">
            </div>
            <div class="form-group">
                <label class="form-label">E-mail</label>
                <input type="email" id="user-email" class="form-control" placeholder="uw@email.nl">
            </div>
            <div class="form-group">
                <label class="form-label">IBAN</label>
                <input type="text" id="user-iban" class="form-control" placeholder="NL00 BANK 0000 0000 00">
            </div>
            <button class="btn btn-primary btn-block" onclick="saveSettings()">
                <i class="fas fa-save"></i> Opslaan
            </button>
        </div>

        <div class="card">
            <div class="card-header">
                <span class="card-title"><i class="fas fa-database"></i> Data</span>
            </div>
            <button class="btn btn-primary btn-block" onclick="exportAllData()">
                <i class="fas fa-download"></i> Exporteer Alles (JSON)
            </button>
            <button class="btn btn-outline btn-block" onclick="importData()" style="margin-top: 10px;">
                <i class="fas fa-upload"></i> Importeer Data
            </button>
            <input type="file" id="import-file" accept=".json" style="display: none;" onchange="handleImport(event)">
            <button class="btn btn-danger btn-block" onclick="clearAllData()" style="margin-top: 10px;">
                <i class="fas fa-trash"></i> Wis Alle Data
            </button>
        </div>

        <div class="card">
            <div class="card-header">
                <span class="card-title"><i class="fas fa-info-circle"></i> Info</span>
            </div>
            <p style="font-size: 0.85rem; color: var(--gray); line-height: 1.6;">
                <strong>Declaratie Module</strong><br>
                Versie 1.0.0<br><br>
                © 2025 Knowledge by Data<br><br>
                <strong>Tarieven:</strong><br>
                • Kilometers: €0,23/km<br>
                • Uren: €75/uur<br>
                • Dagdeel: €300<br>
                • Hele dag: €500
            </p>
        </div>
    </div>
</main>

<!-- Declaration Detail Modal -->
<div class="modal-overlay" id="declaration-modal">
    <div class="modal">
        <div class="modal-header">
            <h3>Declaratie Details</h3>
            <button class="modal-close" onclick="closeDeclarationModal()">&times;</button>
        </div>
        <div class="modal-body" id="declaration-modal-content">
            <!-- Dynamic content -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeDeclarationModal()">Sluiten</button>
            <button class="btn btn-danger" onclick="deleteCurrentDeclaration()">
                <i class="fas fa-trash"></i> Verwijderen
            </button>
        </div>
    </div>
</div>

<div class="toast-container" id="toast-container"></div>

<script>
'use strict';

// ============================================================================
// Constants
// ============================================================================
const KM_RATE = 0.23;
const HOUR_RATE = 75;
const HALFDAY_RATE = 300;
const FULLDAY_RATE = 500;

const CATEGORY_LABELS = {
    'reistijd': 'Reistijd',
    'instructie': 'Instructie',
    'demo': 'Demo'
};

// ============================================================================
// Application State
// ============================================================================
const APP_STATE = {
    declarations: [],
    settings: {
        userName: '',
        userEmail: '',
        userIban: ''
    },
    selectedKmCategory: 'reistijd',
    selectedHoursCategory: 'instructie',
    selectedRate: 'halfday',
    currentDeclarationId: null
};

// ============================================================================
// Initialization
// ============================================================================
document.addEventListener('DOMContentLoaded', () => {
    loadData();
    setupTabs();
    setupCategoryPills();
    setupRateCards();
    setupCalculations();
    updateUI();
    setDefaultDates();
});

function setDefaultDates() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('km-date').value = today;
    document.getElementById('hours-date').value = today;
}

// ============================================================================
// Data Persistence
// ============================================================================
function loadData() {
    try {
        const declarations = localStorage.getItem('declaratie_items');
        const settings = localStorage.getItem('declaratie_settings');
        
        APP_STATE.declarations = declarations ? JSON.parse(declarations) : [];
        APP_STATE.settings = settings ? JSON.parse(settings) : APP_STATE.settings;
        
        document.getElementById('user-name').value = APP_STATE.settings.userName || '';
        document.getElementById('user-email').value = APP_STATE.settings.userEmail || '';
        document.getElementById('user-iban').value = APP_STATE.settings.userIban || '';
    } catch (error) {
        console.error('Error loading data:', error);
    }
}

function saveData() {
    try {
        localStorage.setItem('declaratie_items', JSON.stringify(APP_STATE.declarations));
        localStorage.setItem('declaratie_settings', JSON.stringify(APP_STATE.settings));
    } catch (error) {
        console.error('Error saving data:', error);
        showToast('Fout bij opslaan', 'error');
    }
}

// ============================================================================
// Tab Navigation
// ============================================================================
function setupTabs() {
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.dataset.tab));
    });
}

function switchTab(tabId) {
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabId);
    });
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `tab-${tabId}`);
    });
}

// ============================================================================
// Category Pills
// ============================================================================
function setupCategoryPills() {
    // KM category pills
    document.querySelectorAll('#km-category-pills .category-pill').forEach(pill => {
        pill.addEventListener('click', () => {
            document.querySelectorAll('#km-category-pills .category-pill').forEach(p => p.classList.remove('active'));
            pill.classList.add('active');
            APP_STATE.selectedKmCategory = pill.dataset.category;
        });
    });
    
    // Hours category pills
    document.querySelectorAll('#hours-category-pills .category-pill').forEach(pill => {
        pill.addEventListener('click', () => {
            document.querySelectorAll('#hours-category-pills .category-pill').forEach(p => p.classList.remove('active'));
            pill.classList.add('active');
            APP_STATE.selectedHoursCategory = pill.dataset.category;
        });
    });
}

// ============================================================================
// Rate Cards
// ============================================================================
function setupRateCards() {
    document.querySelectorAll('.rate-card').forEach(card => {
        card.addEventListener('click', () => {
            document.querySelectorAll('.rate-card').forEach(c => c.classList.remove('active'));
            card.classList.add('active');
            APP_STATE.selectedRate = card.dataset.rate;
            updateHoursLabel();
            calculateHours();
        });
    });
}

function updateHoursLabel() {
    const labels = {
        'hour': 'uren',
        'halfday': 'dagdelen',
        'fullday': 'dagen'
    };
    document.getElementById('hours-unit-label').textContent = labels[APP_STATE.selectedRate];
}

// ============================================================================
// Calculations
// ============================================================================
function setupCalculations() {
    document.getElementById('km-amount').addEventListener('input', calculateKm);
    document.getElementById('hours-count').addEventListener('input', calculateHours);
}

function calculateKm() {
    const km = parseFloat(document.getElementById('km-amount').value) || 0;
    const amount = km * KM_RATE;
    document.getElementById('km-calculated').textContent = formatCurrency(amount);
}

function calculateHours() {
    const count = parseInt(document.getElementById('hours-count').value) || 0;
    const rates = {
        'hour': HOUR_RATE,
        'halfday': HALFDAY_RATE,
        'fullday': FULLDAY_RATE
    };
    const amount = count * rates[APP_STATE.selectedRate];
    document.getElementById('hours-calculated').textContent = formatCurrency(amount);
}

// ============================================================================
// Save Declarations
// ============================================================================
function saveKmDeclaration() {
    const date = document.getElementById('km-date').value;
    const km = parseFloat(document.getElementById('km-amount').value);
    const from = document.getElementById('km-from').value.trim();
    const to = document.getElementById('km-to').value.trim();
    const description = document.getElementById('km-description').value.trim();
    
    if (!date) {
        showToast('Selecteer een datum', 'warning');
        return;
    }
    
    if (!km || km <= 0) {
        showToast('Voer het aantal kilometers in', 'warning');
        return;
    }
    
    const amount = km * KM_RATE;
    
    const declaration = {
        id: generateId(),
        type: 'km',
        date: date,
        category: APP_STATE.selectedKmCategory,
        km: km,
        from: from,
        to: to,
        description: description,
        amount: Math.round(amount * 100) / 100,
        status: 'pending',
        createdAt: new Date().toISOString()
    };
    
    APP_STATE.declarations.unshift(declaration);
    saveData();
    updateUI();
    
    // Reset form
    document.getElementById('km-amount').value = '';
    document.getElementById('km-from').value = '';
    document.getElementById('km-to').value = '';
    document.getElementById('km-description').value = '';
    calculateKm();
    
    showToast(`${formatCurrency(amount)} gedeclareerd`, 'success');
    switchTab('dashboard');
}

function saveHoursDeclaration() {
    const date = document.getElementById('hours-date').value;
    const count = parseInt(document.getElementById('hours-count').value);
    const project = document.getElementById('hours-project').value.trim();
    const description = document.getElementById('hours-description').value.trim();
    
    if (!date) {
        showToast('Selecteer een datum', 'warning');
        return;
    }
    
    if (!count || count <= 0) {
        showToast('Voer een aantal in', 'warning');
        return;
    }
    
    const rates = {
        'hour': HOUR_RATE,
        'halfday': HALFDAY_RATE,
        'fullday': FULLDAY_RATE
    };
    
    const hoursMap = {
        'hour': count,
        'halfday': count * 4,
        'fullday': count * 8
    };
    
    const amount = count * rates[APP_STATE.selectedRate];
    
    const declaration = {
        id: generateId(),
        type: 'hours',
        date: date,
        category: APP_STATE.selectedHoursCategory,
        rateType: APP_STATE.selectedRate,
        count: count,
        hours: hoursMap[APP_STATE.selectedRate],
        project: project,
        description: description,
        amount: amount,
        status: 'pending',
        createdAt: new Date().toISOString()
    };
    
    APP_STATE.declarations.unshift(declaration);
    saveData();
    updateUI();
    
    // Reset form
    document.getElementById('hours-count').value = '1';
    document.getElementById('hours-project').value = '';
    document.getElementById('hours-description').value = '';
    calculateHours();
    
    showToast(`${formatCurrency(amount)} gedeclareerd`, 'success');
    switchTab('dashboard');
}

// ============================================================================
// UI Updates
// ============================================================================
function updateUI() {
    updateStats();
    updateTotals();
    updateRecentDeclarations();
}

function updateStats() {
    const totalKm = APP_STATE.declarations
        .filter(d => d.type === 'km')
        .reduce((sum, d) => sum + d.km, 0);
    
    const totalHours = APP_STATE.declarations
        .filter(d => d.type === 'hours')
        .reduce((sum, d) => sum + d.hours, 0);
    
    const pendingCount = APP_STATE.declarations.filter(d => d.status === 'pending').length;
    
    document.getElementById('stat-km').textContent = Math.round(totalKm);
    document.getElementById('stat-hours').textContent = totalHours;
    document.getElementById('stat-count').textContent = APP_STATE.declarations.length;
    document.getElementById('stat-pending').textContent = pendingCount;
}

function updateTotals() {
    const kmAmount = APP_STATE.declarations
        .filter(d => d.type === 'km')
        .reduce((sum, d) => sum + d.amount, 0);
    
    const hoursAmount = APP_STATE.declarations
        .filter(d => d.type === 'hours')
        .reduce((sum, d) => sum + d.amount, 0);
    
    const total = kmAmount + hoursAmount;
    
    document.getElementById('total-km-amount').textContent = formatCurrency(kmAmount);
    document.getElementById('total-hours-amount').textContent = formatCurrency(hoursAmount);
    document.getElementById('total-amount').textContent = formatCurrency(total);
}

function updateRecentDeclarations() {
    const container = document.getElementById('recent-declarations');
    const recent = APP_STATE.declarations.slice(0, 10);
    
    if (recent.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-file-invoice"></i>
                <p>Nog geen declaraties</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = recent.map(d => renderDeclarationItem(d)).join('');
}

function renderDeclarationItem(d) {
    const date = new Date(d.date).toLocaleDateString('nl-NL', { day: 'numeric', month: 'short' });
    const categoryLabel = CATEGORY_LABELS[d.category] || d.category;
    
    if (d.type === 'km') {
        return `
            <div class="declaration-item km" onclick="showDeclarationDetail('${d.id}')">
                <div class="declaration-item-header">
                    <span class="declaration-item-type"><i class="fas fa-car"></i> ${d.km} km</span>
                    <span class="declaration-item-amount km">${formatCurrency(d.amount)}</span>
                </div>
                <div class="declaration-item-category">${categoryLabel}</div>
                <div class="declaration-item-meta">
                    <span><i class="fas fa-calendar"></i> ${date}</span>
                    ${d.from && d.to ? `<span><i class="fas fa-route"></i> ${escapeHtml(d.from)} → ${escapeHtml(d.to)}</span>` : ''}
                </div>
            </div>
        `;
    } else {
        const rateLabels = { 'hour': 'uur', 'halfday': 'dagdeel', 'fullday': 'dag' };
        return `
            <div class="declaration-item hours" onclick="showDeclarationDetail('${d.id}')">
                <div class="declaration-item-header">
                    <span class="declaration-item-type"><i class="fas fa-clock"></i> ${d.count} ${rateLabels[d.rateType]}</span>
                    <span class="declaration-item-amount">${formatCurrency(d.amount)}</span>
                </div>
                <div class="declaration-item-category">${categoryLabel}</div>
                <div class="declaration-item-meta">
                    <span><i class="fas fa-calendar"></i> ${date}</span>
                    ${d.project ? `<span><i class="fas fa-briefcase"></i> ${escapeHtml(d.project)}</span>` : ''}
                </div>
            </div>
        `;
    }
}

// ============================================================================
// Declaration Detail Modal
// ============================================================================
function showDeclarationDetail(id) {
    const d = APP_STATE.declarations.find(x => x.id === id);
    if (!d) return;
    
    APP_STATE.currentDeclarationId = id;
    
    const date = new Date(d.date).toLocaleDateString('nl-NL');
    const categoryLabel = CATEGORY_LABELS[d.category] || d.category;
    
    let content = '';
    
    if (d.type === 'km') {
        content = `
            <div class="form-group">
                <label class="form-label">Type</label>
                <p><i class="fas fa-car"></i> Kilometervergoeding</p>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Datum</label>
                    <p>${date}</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Categorie</label>
                    <p>${categoryLabel}</p>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Kilometers</label>
                    <p style="font-weight: 600;">${d.km} km</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Bedrag</label>
                    <p style="font-weight: 600; color: var(--accent);">${formatCurrency(d.amount)}</p>
                </div>
            </div>
            ${d.from || d.to ? `
            <div class="form-group">
                <label class="form-label">Route</label>
                <p>${escapeHtml(d.from || '-')} → ${escapeHtml(d.to || '-')}</p>
            </div>
            ` : ''}
            ${d.description ? `
            <div class="form-group">
                <label class="form-label">Omschrijving</label>
                <p>${escapeHtml(d.description)}</p>
            </div>
            ` : ''}
        `;
    } else {
        const rateLabels = { 'hour': 'Per uur (€75)', 'halfday': 'Per dagdeel (€300)', 'fullday': 'Per dag (€500)' };
        content = `
            <div class="form-group">
                <label class="form-label">Type</label>
                <p><i class="fas fa-clock"></i> Uren declaratie</p>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Datum</label>
                    <p>${date}</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Categorie</label>
                    <p>${categoryLabel}</p>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Tarief</label>
                <p>${rateLabels[d.rateType]}</p>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Aantal</label>
                    <p style="font-weight: 600;">${d.count}</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Bedrag</label>
                    <p style="font-weight: 600; color: var(--primary);">${formatCurrency(d.amount)}</p>
                </div>
            </div>
            ${d.project ? `
            <div class="form-group">
                <label class="form-label">Project / Klant</label>
                <p>${escapeHtml(d.project)}</p>
            </div>
            ` : ''}
            ${d.description ? `
            <div class="form-group">
                <label class="form-label">Omschrijving</label>
                <p>${escapeHtml(d.description)}</p>
            </div>
            ` : ''}
        `;
    }
    
    document.getElementById('declaration-modal-content').innerHTML = content;
    document.getElementById('declaration-modal').classList.add('active');
}

function closeDeclarationModal() {
    document.getElementById('declaration-modal').classList.remove('active');
    APP_STATE.currentDeclarationId = null;
}

function deleteCurrentDeclaration() {
    if (!APP_STATE.currentDeclarationId) return;
    if (!confirm('Declaratie verwijderen?')) return;
    
    APP_STATE.declarations = APP_STATE.declarations.filter(d => d.id !== APP_STATE.currentDeclarationId);
    saveData();
    updateUI();
    closeDeclarationModal();
    showToast('Verwijderd', 'success');
}

// ============================================================================
// Settings & Export
// ============================================================================
function saveSettings() {
    APP_STATE.settings.userName = document.getElementById('user-name').value.trim();
    APP_STATE.settings.userEmail = document.getElementById('user-email').value.trim();
    APP_STATE.settings.userIban = document.getElementById('user-iban').value.trim();
    saveData();
    showToast('Opgeslagen', 'success');
}

function exportDeclarations() {
    if (APP_STATE.declarations.length === 0) {
        showToast('Geen declaraties om te exporteren', 'warning');
        return;
    }
    
    const headers = ['Datum', 'Type', 'Categorie', 'Omschrijving', 'Kilometers', 'Uren', 'Bedrag'];
    
    const rows = APP_STATE.declarations.map(d => {
        const categoryLabel = CATEGORY_LABELS[d.category] || d.category;
        let desc = d.description || '';
        if (d.type === 'km' && d.from && d.to) {
            desc = `${d.from} → ${d.to}${desc ? ': ' + desc : ''}`;
        } else if (d.type === 'hours' && d.project) {
            desc = `${d.project}${desc ? ': ' + desc : ''}`;
        }
        
        return [
            new Date(d.date).toLocaleDateString('nl-NL'),
            d.type === 'km' ? 'Kilometers' : 'Uren',
            categoryLabel,
            desc,
            d.type === 'km' ? d.km : '',
            d.type === 'hours' ? d.hours : '',
            d.amount.toFixed(2).replace('.', ',')
        ];
    });
    
    // Add totals
    const totalKm = APP_STATE.declarations.filter(d => d.type === 'km').reduce((s, d) => s + d.km, 0);
    const totalHours = APP_STATE.declarations.filter(d => d.type === 'hours').reduce((s, d) => s + d.hours, 0);
    const totalAmount = APP_STATE.declarations.reduce((s, d) => s + d.amount, 0);
    
    rows.push([]);
    rows.push(['TOTAAL', '', '', '', totalKm || '', totalHours || '', totalAmount.toFixed(2).replace('.', ',')]);
    
    const csv = [headers, ...rows]
        .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(';'))
        .join('\n');
    
    downloadFile(`\uFEFF${csv}`, `declaraties_${APP_STATE.settings.userName || 'export'}_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv;charset=utf-8');
    showToast('Geëxporteerd', 'success');
}

function exportAllData() {
    const data = {
        version: '1.0.0',
        exportedAt: new Date().toISOString(),
        settings: APP_STATE.settings,
        declarations: APP_STATE.declarations
    };
    
    downloadFile(JSON.stringify(data, null, 2), `declaratie_backup_${new Date().toISOString().split('T')[0]}.json`, 'application/json');
    showToast('Backup geëxporteerd', 'success');
}

function importData() {
    document.getElementById('import-file').click();
}

function handleImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);
            
            if (!data.declarations || !Array.isArray(data.declarations)) {
                throw new Error('Ongeldig bestandsformaat');
            }
            
            if (!confirm(`${data.declarations.length} declaraties importeren?`)) return;
            
            APP_STATE.declarations = data.declarations;
            if (data.settings) {
                APP_STATE.settings = { ...APP_STATE.settings, ...data.settings };
            }
            
            saveData();
            loadData();
            updateUI();
            
            showToast(`${data.declarations.length} declaraties geïmporteerd`, 'success');
        } catch (error) {
            showToast('Fout bij importeren: ' + error.message, 'error');
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

function clearAllData() {
    if (!confirm('ALLE declaraties verwijderen?')) return;
    if (!confirm('Weet u het zeker?')) return;
    
    APP_STATE.declarations = [];
    saveData();
    updateUI();
    showToast('Data verwijderd', 'success');
}

// ============================================================================
// Utility Functions
// ============================================================================
function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatCurrency(amount) {
    return '€ ' + amount.toFixed(2).replace('.', ',');
}

function downloadFile(content, filename, type) {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Service Worker
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(err => console.error('SW error:', err));
    });
}

console.log('%c Declaratie Module v1.0.0', 'font-size:16px;font-weight:bold;color:#9c27b0');
</script>
</body>
</html>
