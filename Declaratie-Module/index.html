<!DOCTYPE html>
<!--
================================================================================
Declaratie Module - Declaraties voor Knowledge by Data
Versie: 2.0.0 PWA | Knowledge by Data
================================================================================
Copyright (c) 2025 L.P. Antenbrink, Knowledge by Data. Alle rechten voorbehouden.
================================================================================
-->
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#9c27b0">
<title>Declaratie Module</title>
<link rel="manifest" href="./manifest.json">
<link rel="apple-touch-icon" href="./icons/icon-192x192.png">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
:root {
    --primary: #9c27b0;
    --primary-dark: #7b1fa2;
    --primary-light: #ce93d8;
    --accent: #00bcd4;
    --success: #4caf50;
    --warning: #ff9800;
    --danger: #f44336;
    --dark: #1a1a2e;
    --light: #f5f5f5;
    --gray: #757575;
    --gray-light: #e0e0e0;
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--light);
    min-height: 100vh;
    color: var(--dark);
}

.hidden { display: none !important; }

/* Auth Screen */
.auth-screen {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--dark), #16213e);
    padding: 20px;
}

.auth-box {
    background: rgba(255,255,255,0.05);
    padding: 40px;
    border-radius: 20px;
    width: 100%;
    max-width: 400px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
    text-align: center;
}

.auth-box h1 { color: var(--primary-light); font-size: 1.8rem; margin-bottom: 10px; }
.auth-box p { color: var(--gray); margin-bottom: 30px; }

.auth-box input {
    width: 100%;
    padding: 15px;
    margin-bottom: 15px;
    border: 2px solid rgba(255,255,255,0.1);
    border-radius: 10px;
    background: rgba(0,0,0,0.3);
    color: white;
    font-size: 1rem;
    text-align: center;
}

.auth-box input::placeholder { color: var(--gray); }
.auth-box input:focus { outline: none; border-color: var(--primary); }

.auth-box button {
    width: 100%;
    padding: 15px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
}

.auth-error { color: var(--danger); font-size: 0.85rem; margin-top: 10px; }

/* App */
.app-container { display: none; }
.app-container.active { display: block; }

.security-bar {
    background: var(--primary);
    color: white;
    padding: 8px 15px;
    font-size: 0.75rem;
    text-align: center;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
}

.app-header {
    background: linear-gradient(135deg, var(--dark), #16213e);
    color: white;
    padding: 20px;
    padding-top: 45px;
    text-align: center;
}

.app-header h1 { font-size: 1.3rem; color: var(--primary-light); margin-bottom: 5px; }
.app-header .user-name { color: var(--gray); font-size: 0.85rem; }

.nav-tabs {
    display: flex;
    background: white;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    position: sticky;
    top: 30px;
    z-index: 100;
}

.nav-tab {
    flex: 1;
    padding: 12px 8px;
    text-align: center;
    border: none;
    background: none;
    cursor: pointer;
    font-size: 0.7rem;
    color: var(--gray);
    border-bottom: 3px solid transparent;
}

.nav-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
.nav-tab i { display: block; font-size: 1.1rem; margin-bottom: 3px; }

.main-content { padding: 15px; padding-bottom: 100px; }

.tab-content { display: none; }
.tab-content.active { display: block; }

.card {
    background: white;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--gray-light);
}

.card-title { font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
.card-title i { color: var(--primary); }

/* Totals Display */
.totals-display {
    background: linear-gradient(135deg, var(--dark), #16213e);
    color: white;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 15px;
}

.totals-display h3 { font-size: 0.9rem; margin-bottom: 15px; opacity: 0.9; }

.totals-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

.total-item { text-align: center; }
.total-item .label { font-size: 0.75rem; opacity: 0.8; margin-bottom: 4px; }
.total-item .value { font-size: 1.3rem; font-weight: bold; }
.total-item.highlight .value { color: var(--primary-light); }

.form-group { margin-bottom: 15px; }
.form-label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; }

.form-control {
    width: 100%;
    padding: 12px;
    border: 2px solid var(--gray-light);
    border-radius: 10px;
    font-size: 1rem;
}

.form-control:focus { outline: none; border-color: var(--primary); }

.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

/* Category Pills */
.category-pills { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }

.category-pill {
    padding: 10px 16px;
    border: 2px solid var(--gray-light);
    border-radius: 20px;
    background: white;
    cursor: pointer;
    font-size: 0.85rem;
}

.category-pill:hover { border-color: var(--primary); }
.category-pill.active { border-color: var(--primary); background: var(--primary); color: white; }

/* Rate Cards */
.rate-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }

.rate-card {
    padding: 15px 10px;
    border: 2px solid var(--gray-light);
    border-radius: 12px;
    background: white;
    cursor: pointer;
    text-align: center;
}

.rate-card:hover { border-color: var(--primary); }
.rate-card.active { border-color: var(--primary); background: var(--primary); color: white; }
.rate-card .rate-amount { font-size: 1.2rem; font-weight: bold; margin-bottom: 4px; }
.rate-card .rate-label { font-size: 0.75rem; opacity: 0.8; }

.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 20px;
    border-radius: 10px;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    border: none;
}

.btn-primary { background: var(--primary); color: white; }
.btn-accent { background: var(--accent); color: white; }
.btn-danger { background: var(--danger); color: white; }
.btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
.btn-block { width: 100%; }
.btn-lg { padding: 15px 24px; font-size: 1rem; }

/* Declaration List */
.declaration-list { display: flex; flex-direction: column; gap: 10px; }

.declaration-item {
    background: var(--light);
    border-radius: 12px;
    padding: 14px;
    border-left: 4px solid var(--primary);
}

.declaration-item.km { border-left-color: var(--accent); }

.declaration-item-header { display: flex; justify-content: space-between; margin-bottom: 6px; }
.declaration-item-type { font-weight: 600; font-size: 0.95rem; }

.declaration-item-amount {
    background: var(--primary);
    color: white;
    padding: 3px 10px;
    border-radius: 10px;
    font-size: 0.85rem;
    font-weight: 600;
}

.declaration-item-amount.km { background: var(--accent); }
.declaration-item-meta { font-size: 0.8rem; color: var(--gray); }

.info-box {
    background: rgba(156, 39, 176, 0.1);
    border-left: 4px solid var(--primary);
    padding: 12px 15px;
    border-radius: 0 8px 8px 0;
    font-size: 0.85rem;
    margin-bottom: 15px;
}

.info-box.accent { background: rgba(0, 188, 212, 0.1); border-left-color: var(--accent); }

/* Toast */
.toast-container { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 2000; }

.toast {
    background: var(--dark);
    color: white;
    padding: 12px 20px;
    border-radius: 10px;
    margin-top: 8px;
    animation: slideUp 0.3s ease;
}

.toast.success { background: var(--success); }
.toast.error { background: var(--danger); }

@keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.empty-state { text-align: center; padding: 40px 20px; color: var(--gray); }
.empty-state i { font-size: 3rem; margin-bottom: 15px; opacity: 0.3; }
</style>
</head>
<body>

<!-- Auth Screen -->
<div class="auth-screen" id="auth-screen">
    <div class="auth-box">
        <h1><i class="fas fa-file-invoice-dollar"></i> Declaratie Module</h1>
        <p>Voer uw gegevens in om te starten</p>
        <input type="text" id="auth-name" placeholder="Uw naam" autocomplete="name">
        <input type="password" id="auth-pin" placeholder="Pincode" maxlength="4" inputmode="numeric">
        <button onclick="authenticate()"><i class="fas fa-sign-in-alt"></i> Inloggen</button>
        <div class="auth-error" id="auth-error"></div>
        <p style="margin-top: 20px; font-size: 0.75rem; color: var(--gray);">Pincode: 2024</p>
    </div>
</div>

<!-- App Container -->
<div class="app-container" id="app-container">
    <div class="security-bar"><i class="fas fa-lock"></i> Declaraties - Knowledge by Data</div>

    <header class="app-header">
        <h1><i class="fas fa-file-invoice-dollar"></i> Declaratie Module</h1>
        <p class="user-name">Medewerker: <span id="display-user-name">-</span></p>
    </header>

    <nav class="nav-tabs">
        <button class="nav-tab active" data-tab="dashboard"><i class="fas fa-home"></i> Overzicht</button>
        <button class="nav-tab" data-tab="km"><i class="fas fa-car"></i> Kilometers</button>
        <button class="nav-tab" data-tab="hours"><i class="fas fa-clock"></i> Uren</button>
        <button class="nav-tab" data-tab="export"><i class="fas fa-download"></i> Export</button>
    </nav>

    <main class="main-content">
        <!-- Dashboard -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="totals-display">
                <h3><i class="fas fa-chart-line"></i> Totaal te declareren</h3>
                <div class="totals-grid">
                    <div class="total-item">
                        <div class="label">Kilometers</div>
                        <div class="value" id="total-km-amount">€ 0,00</div>
                    </div>
                    <div class="total-item">
                        <div class="label">Uren</div>
                        <div class="value" id="total-hours-amount">€ 0,00</div>
                    </div>
                    <div class="total-item highlight" style="grid-column: span 2;">
                        <div class="label">Totaal</div>
                        <div class="value" id="total-amount">€ 0,00</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title"><i class="fas fa-list"></i> Recente Declaraties</span>
                </div>
                <div id="recent-declarations" class="declaration-list"></div>
            </div>

            <div class="form-row">
                <button class="btn btn-accent btn-lg" onclick="switchTab('km')"><i class="fas fa-car"></i> KM</button>
                <button class="btn btn-primary btn-lg" onclick="switchTab('hours')"><i class="fas fa-clock"></i> Uren</button>
            </div>
        </div>

        <!-- KM Tab -->
        <div id="tab-km" class="tab-content">
            <div class="info-box accent">
                <strong>Kilometervergoeding:</strong> €0,23 per kilometer
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title"><i class="fas fa-car"></i> Kilometervergoeding</span>
                </div>

                <div class="form-group">
                    <label class="form-label">Datum</label>
                    <input type="date" id="km-date" class="form-control">
                </div>

                <div class="form-group">
                    <label class="form-label">Categorie</label>
                    <div class="category-pills" id="km-category-pills">
                        <button class="category-pill active" data-category="reistijd"><i class="fas fa-car"></i> Reistijd</button>
                        <button class="category-pill" data-category="instructie"><i class="fas fa-chalkboard-teacher"></i> Instructie</button>
                        <button class="category-pill" data-category="demo"><i class="fas fa-desktop"></i> Demo</button>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Van</label>
                        <input type="text" id="km-from" class="form-control" placeholder="Vertrek">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Naar</label>
                        <input type="text" id="km-to" class="form-control" placeholder="Bestemming">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Aantal kilometers</label>
                    <input type="number" id="km-amount" class="form-control" placeholder="120" min="1">
                </div>

                <div class="form-group">
                    <label class="form-label">Vergoeding</label>
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent);" id="km-calculated">€ 0,00</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Omschrijving</label>
                    <input type="text" id="km-description" class="form-control" placeholder="Klantbezoek...">
                </div>

                <button class="btn btn-accent btn-block btn-lg" onclick="saveKm()">
                    <i class="fas fa-save"></i> Opslaan
                </button>
            </div>
        </div>

        <!-- Hours Tab -->
        <div id="tab-hours" class="tab-content">
            <div class="info-box">
                <strong>Tarieven:</strong> €75/uur | €300/dagdeel | €500/dag
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title"><i class="fas fa-clock"></i> Uren Declareren</span>
                </div>

                <div class="form-group">
                    <label class="form-label">Datum</label>
                    <input type="date" id="hours-date" class="form-control">
                </div>

                <div class="form-group">
                    <label class="form-label">Categorie</label>
                    <div class="category-pills" id="hours-category-pills">
                        <button class="category-pill active" data-category="instructie"><i class="fas fa-chalkboard-teacher"></i> Instructie</button>
                        <button class="category-pill" data-category="reistijd"><i class="fas fa-car"></i> Reistijd</button>
                        <button class="category-pill" data-category="demo"><i class="fas fa-desktop"></i> Demo</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Tarief</label>
                    <div class="rate-grid" id="rate-grid">
                        <div class="rate-card" data-rate="hour" data-amount="75">
                            <div class="rate-amount">€75</div>
                            <div class="rate-label">per uur</div>
                        </div>
                        <div class="rate-card active" data-rate="halfday" data-amount="300">
                            <div class="rate-amount">€300</div>
                            <div class="rate-label">dagdeel</div>
                        </div>
                        <div class="rate-card" data-rate="fullday" data-amount="500">
                            <div class="rate-amount">€500</div>
                            <div class="rate-label">dag</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Aantal <span id="rate-unit">dagdelen</span></label>
                    <input type="number" id="hours-count" class="form-control" value="1" min="1">
                </div>

                <div class="form-group">
                    <label class="form-label">Totaal</label>
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);" id="hours-calculated">€ 300,00</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Project / Klant</label>
                    <input type="text" id="hours-project" class="form-control" placeholder="Training Gemeente X">
                </div>

                <div class="form-group">
                    <label class="form-label">Omschrijving</label>
                    <textarea id="hours-description" class="form-control" rows="2" placeholder="Wat heb je gedaan?"></textarea>
                </div>

                <button class="btn btn-primary btn-block btn-lg" onclick="saveHours()">
                    <i class="fas fa-save"></i> Opslaan
                </button>
            </div>
        </div>

        <!-- Export Tab -->
        <div id="tab-export" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><i class="fas fa-download"></i> Exporteren</span>
                </div>
                <p style="color: var(--gray); margin-bottom: 20px; font-size: 0.9rem;">
                    Exporteer alle declaraties als JSON voor Knowledge by Data administratie.
                </p>
                <button class="btn btn-primary btn-block btn-lg" onclick="exportJSON()">
                    <i class="fas fa-file-code"></i> Exporteer JSON
                </button>
                <button class="btn btn-outline btn-block" onclick="exportCSV()" style="margin-top: 10px;">
                    <i class="fas fa-file-csv"></i> Exporteer CSV
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title"><i class="fas fa-user"></i> Sessie</span>
                </div>
                <button class="btn btn-danger btn-block" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Uitloggen
                </button>
            </div>
        </div>
    </main>
</div>

<div class="toast-container" id="toast-container"></div>

<script>
'use strict';

const VALID_PIN = '2024';
const KM_RATE = 0.23;
const RATES = { hour: 75, halfday: 300, fullday: 500 };
const RATE_LABELS = { hour: 'uren', halfday: 'dagdelen', fullday: 'dagen' };
const CATEGORY_LABELS = { reistijd: 'Reistijd', instructie: 'Instructie', demo: 'Demo' };

const APP_STATE = {
    user: null,
    declarations: [],
    kmCategory: 'reistijd',
    hoursCategory: 'instructie',
    selectedRate: 'halfday'
};

// Auth
function authenticate() {
    const name = document.getElementById('auth-name').value.trim();
    const pin = document.getElementById('auth-pin').value;
    const errorEl = document.getElementById('auth-error');
    
    if (!name) { errorEl.textContent = 'Voer uw naam in'; return; }
    if (pin !== VALID_PIN) { errorEl.textContent = 'Ongeldige pincode'; return; }
    
    APP_STATE.user = name;
    localStorage.setItem('decl_user', name);
    loadData();
    showApp();
}

function showApp() {
    document.getElementById('auth-screen').classList.add('hidden');
    document.getElementById('app-container').classList.add('active');
    document.getElementById('display-user-name').textContent = APP_STATE.user;
    updateUI();
}

function logout() {
    if (!confirm('Weet u zeker dat u wilt uitloggen?')) return;
    localStorage.removeItem('decl_user');
    location.reload();
}

function checkSession() {
    const savedUser = localStorage.getItem('decl_user');
    if (savedUser) {
        APP_STATE.user = savedUser;
        loadData();
        showApp();
    }
}

// Data
function loadData() {
    const data = localStorage.getItem('decl_items_' + APP_STATE.user);
    APP_STATE.declarations = data ? JSON.parse(data) : [];
}

function saveData() {
    localStorage.setItem('decl_items_' + APP_STATE.user, JSON.stringify(APP_STATE.declarations));
}

// Tabs
document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', () => switchTab(tab.dataset.tab));
});

function switchTab(tabId) {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tabId));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === 'tab-' + tabId));
    
    if (tabId === 'km') document.getElementById('km-date').value = new Date().toISOString().split('T')[0];
    if (tabId === 'hours') document.getElementById('hours-date').value = new Date().toISOString().split('T')[0];
}

// Category Pills
document.querySelectorAll('#km-category-pills .category-pill').forEach(p => {
    p.addEventListener('click', () => {
        document.querySelectorAll('#km-category-pills .category-pill').forEach(x => x.classList.remove('active'));
        p.classList.add('active');
        APP_STATE.kmCategory = p.dataset.category;
    });
});

document.querySelectorAll('#hours-category-pills .category-pill').forEach(p => {
    p.addEventListener('click', () => {
        document.querySelectorAll('#hours-category-pills .category-pill').forEach(x => x.classList.remove('active'));
        p.classList.add('active');
        APP_STATE.hoursCategory = p.dataset.category;
    });
});

// Rate Cards
document.querySelectorAll('.rate-card').forEach(card => {
    card.addEventListener('click', () => {
        document.querySelectorAll('.rate-card').forEach(c => c.classList.remove('active'));
        card.classList.add('active');
        APP_STATE.selectedRate = card.dataset.rate;
        document.getElementById('rate-unit').textContent = RATE_LABELS[APP_STATE.selectedRate];
        calculateHours();
    });
});

// Calculations
document.getElementById('km-amount').addEventListener('input', () => {
    const km = parseFloat(document.getElementById('km-amount').value) || 0;
    document.getElementById('km-calculated').textContent = formatCurrency(km * KM_RATE);
});

document.getElementById('hours-count').addEventListener('input', calculateHours);

function calculateHours() {
    const count = parseInt(document.getElementById('hours-count').value) || 0;
    document.getElementById('hours-calculated').textContent = formatCurrency(count * RATES[APP_STATE.selectedRate]);
}

// Save KM
function saveKm() {
    const date = document.getElementById('km-date').value;
    const km = parseFloat(document.getElementById('km-amount').value);
    const from = document.getElementById('km-from').value.trim();
    const to = document.getElementById('km-to').value.trim();
    const description = document.getElementById('km-description').value.trim();
    
    if (!date || !km || km <= 0) { showToast('Vul datum en kilometers in', 'error'); return; }
    
    const declaration = {
        id: Date.now().toString(36),
        type: 'km',
        date,
        category: APP_STATE.kmCategory,
        km,
        from,
        to,
        description,
        amount: Math.round(km * KM_RATE * 100) / 100,
        createdAt: new Date().toISOString()
    };
    
    APP_STATE.declarations.unshift(declaration);
    saveData();
    updateUI();
    
    document.getElementById('km-amount').value = '';
    document.getElementById('km-from').value = '';
    document.getElementById('km-to').value = '';
    document.getElementById('km-description').value = '';
    document.getElementById('km-calculated').textContent = '€ 0,00';
    
    showToast(`${formatCurrency(declaration.amount)} gedeclareerd`, 'success');
    switchTab('dashboard');
}

// Save Hours
function saveHours() {
    const date = document.getElementById('hours-date').value;
    const count = parseInt(document.getElementById('hours-count').value);
    const project = document.getElementById('hours-project').value.trim();
    const description = document.getElementById('hours-description').value.trim();
    
    if (!date || !count || count <= 0) { showToast('Vul datum en aantal in', 'error'); return; }
    
    const hoursMap = { hour: 1, halfday: 4, fullday: 8 };
    
    const declaration = {
        id: Date.now().toString(36),
        type: 'hours',
        date,
        category: APP_STATE.hoursCategory,
        rateType: APP_STATE.selectedRate,
        count,
        hours: count * hoursMap[APP_STATE.selectedRate],
        project,
        description,
        amount: count * RATES[APP_STATE.selectedRate],
        createdAt: new Date().toISOString()
    };
    
    APP_STATE.declarations.unshift(declaration);
    saveData();
    updateUI();
    
    document.getElementById('hours-count').value = '1';
    document.getElementById('hours-project').value = '';
    document.getElementById('hours-description').value = '';
    calculateHours();
    
    showToast(`${formatCurrency(declaration.amount)} gedeclareerd`, 'success');
    switchTab('dashboard');
}

// UI Updates
function updateUI() {
    updateTotals();
    updateRecentDeclarations();
}

function updateTotals() {
    const kmAmount = APP_STATE.declarations.filter(d => d.type === 'km').reduce((s, d) => s + d.amount, 0);
    const hoursAmount = APP_STATE.declarations.filter(d => d.type === 'hours').reduce((s, d) => s + d.amount, 0);
    
    document.getElementById('total-km-amount').textContent = formatCurrency(kmAmount);
    document.getElementById('total-hours-amount').textContent = formatCurrency(hoursAmount);
    document.getElementById('total-amount').textContent = formatCurrency(kmAmount + hoursAmount);
}

function updateRecentDeclarations() {
    const container = document.getElementById('recent-declarations');
    const recent = APP_STATE.declarations.slice(0, 10);
    
    if (recent.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-file-invoice"></i><p>Nog geen declaraties</p></div>';
        return;
    }
    
    container.innerHTML = recent.map(d => {
        const date = new Date(d.date).toLocaleDateString('nl-NL', { day: 'numeric', month: 'short' });
        const catLabel = CATEGORY_LABELS[d.category] || d.category;
        
        if (d.type === 'km') {
            return `
                <div class="declaration-item km">
                    <div class="declaration-item-header">
                        <span class="declaration-item-type"><i class="fas fa-car"></i> ${d.km} km</span>
                        <span class="declaration-item-amount km">${formatCurrency(d.amount)}</span>
                    </div>
                    <div class="declaration-item-meta">${date} | ${catLabel}</div>
                </div>
            `;
        } else {
            return `
                <div class="declaration-item">
                    <div class="declaration-item-header">
                        <span class="declaration-item-type"><i class="fas fa-clock"></i> ${d.count}× ${RATE_LABELS[d.rateType]}</span>
                        <span class="declaration-item-amount">${formatCurrency(d.amount)}</span>
                    </div>
                    <div class="declaration-item-meta">${date} | ${catLabel}</div>
                </div>
            `;
        }
    }).join('');
}

// Export
function exportJSON() {
    if (APP_STATE.declarations.length === 0) { showToast('Geen data om te exporteren', 'error'); return; }
    
    const kmDeclarations = APP_STATE.declarations.filter(d => d.type === 'km');
    const hoursDeclarations = APP_STATE.declarations.filter(d => d.type === 'hours');
    
    const exportData = {
        type: 'declaratie',
        version: '2.0.0',
        medewerker: APP_STATE.user,
        exportDatum: new Date().toISOString(),
        periode: {
            van: APP_STATE.declarations[APP_STATE.declarations.length - 1].date,
            tot: APP_STATE.declarations[0].date
        },
        totalen: {
            aantalDeclaraties: APP_STATE.declarations.length,
            kilometers: {
                aantal: kmDeclarations.length,
                totaalKm: kmDeclarations.reduce((s, d) => s + d.km, 0),
                totaalBedrag: kmDeclarations.reduce((s, d) => s + d.amount, 0)
            },
            uren: {
                aantal: hoursDeclarations.length,
                totaalUren: hoursDeclarations.reduce((s, d) => s + d.hours, 0),
                totaalBedrag: hoursDeclarations.reduce((s, d) => s + d.amount, 0)
            },
            totaalBedrag: APP_STATE.declarations.reduce((s, d) => s + d.amount, 0)
        },
        declaraties: APP_STATE.declarations
    };
    
    const filename = `declaratie_${APP_STATE.user.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
    downloadFile(JSON.stringify(exportData, null, 2), filename, 'application/json');
    showToast('JSON geëxporteerd', 'success');
}

function exportCSV() {
    if (APP_STATE.declarations.length === 0) { showToast('Geen data om te exporteren', 'error'); return; }
    
    const headers = ['Medewerker', 'Datum', 'Type', 'Categorie', 'Kilometers', 'Uren', 'Bedrag', 'Omschrijving'];
    const rows = APP_STATE.declarations.map(d => [
        APP_STATE.user,
        d.date,
        d.type === 'km' ? 'Kilometers' : 'Uren',
        CATEGORY_LABELS[d.category] || d.category,
        d.type === 'km' ? d.km : '',
        d.type === 'hours' ? d.hours : '',
        d.amount.toFixed(2).replace('.', ','),
        d.description || d.project || ''
    ]);
    
    const csv = [headers, ...rows].map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(';')).join('\n');
    const filename = `declaratie_${APP_STATE.user.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
    downloadFile('\uFEFF' + csv, filename, 'text/csv;charset=utf-8');
    showToast('CSV geëxporteerd', 'success');
}

// Utils
function formatCurrency(amount) {
    return '€ ' + amount.toFixed(2).replace('.', ',');
}

function downloadFile(content, filename, type) {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast ' + type;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Init
document.addEventListener('DOMContentLoaded', checkSession);

if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(err => console.error('SW:', err));
}
</script>
</body>
</html>
