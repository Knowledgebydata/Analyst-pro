<!DOCTYPE html>
<!--
================================================================================
KM Registratie Pro - Sluitende Kilometerregistratie
Versie: 2.0.0 PWA | Knowledge by Data
================================================================================
Copyright (c) 2025 L.P. Antenbrink, Knowledge by Data. Alle rechten voorbehouden.
================================================================================
-->
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#2e7d32">
<title>KM Registratie Pro</title>
<link rel="manifest" href="./manifest.json">
<link rel="apple-touch-icon" href="./icons/icon-192x192.png">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
:root {
    --primary: #2e7d32;
    --primary-dark: #1b5e20;
    --primary-light: #4caf50;
    --accent: #ff9800;
    --success: #43a047;
    --warning: #ffc107;
    --danger: #e53935;
    --dark: #1a1a2e;
    --light: #f5f5f5;
    --gray: #757575;
    --gray-light: #e0e0e0;
    --white: #ffffff;
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--light);
    min-height: 100vh;
    color: var(--dark);
}

.hidden { display: none !important; }

/* Auth Screen */
.auth-screen {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--dark), #16213e);
    padding: 20px;
}

.auth-box {
    background: rgba(255,255,255,0.05);
    padding: 40px;
    border-radius: 20px;
    width: 100%;
    max-width: 400px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
    text-align: center;
}

.auth-box h1 {
    color: var(--primary-light);
    font-size: 1.8rem;
    margin-bottom: 10px;
}

.auth-box p {
    color: var(--gray);
    margin-bottom: 30px;
}

.auth-box input {
    width: 100%;
    padding: 15px;
    margin-bottom: 15px;
    border: 2px solid rgba(255,255,255,0.1);
    border-radius: 10px;
    background: rgba(0,0,0,0.3);
    color: white;
    font-size: 1rem;
    text-align: center;
}

.auth-box input::placeholder { color: var(--gray); }
.auth-box input:focus { outline: none; border-color: var(--primary); }

.auth-box button {
    width: 100%;
    padding: 15px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
}

.auth-box button:hover { background: var(--primary-dark); }

.auth-error {
    color: var(--danger);
    font-size: 0.85rem;
    margin-top: 10px;
}

/* App */
.app-container { display: none; }
.app-container.active { display: block; }

.security-bar {
    background: var(--primary);
    color: white;
    padding: 8px 15px;
    font-size: 0.75rem;
    text-align: center;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
}

.app-header {
    background: linear-gradient(135deg, var(--dark), #16213e);
    color: white;
    padding: 20px;
    padding-top: 45px;
    text-align: center;
}

.app-header h1 {
    font-size: 1.3rem;
    color: var(--primary-light);
    margin-bottom: 5px;
}

.app-header .user-name {
    color: var(--gray);
    font-size: 0.85rem;
}

.nav-tabs {
    display: flex;
    background: white;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    position: sticky;
    top: 30px;
    z-index: 100;
}

.nav-tab {
    flex: 1;
    padding: 12px 8px;
    text-align: center;
    border: none;
    background: none;
    cursor: pointer;
    font-size: 0.75rem;
    color: var(--gray);
    border-bottom: 3px solid transparent;
}

.nav-tab.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
}

.nav-tab i { display: block; font-size: 1.1rem; margin-bottom: 3px; }

.main-content {
    padding: 15px;
    padding-bottom: 100px;
}

.tab-content { display: none; }
.tab-content.active { display: block; }

.card {
    background: white;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--gray-light);
}

.card-title {
    font-size: 1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.card-title i { color: var(--primary); }

.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 15px;
}

.stat-card {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 15px;
    border-radius: 12px;
    text-align: center;
}

.stat-card.accent { background: linear-gradient(135deg, var(--accent), #f57c00); }
.stat-card.neutral { background: linear-gradient(135deg, #607d8b, #455a64); }

.stat-number { font-size: 1.5rem; font-weight: bold; }
.stat-label { font-size: 0.7rem; opacity: 0.9; }

.form-group { margin-bottom: 15px; }

.form-label {
    display: block;
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 5px;
}

.form-control {
    width: 100%;
    padding: 12px;
    border: 2px solid var(--gray-light);
    border-radius: 10px;
    font-size: 1rem;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 20px;
    border-radius: 10px;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    border: none;
}

.btn-primary { background: var(--primary); color: white; }
.btn-accent { background: var(--accent); color: white; }
.btn-danger { background: var(--danger); color: white; }
.btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
.btn-block { width: 100%; }
.btn-lg { padding: 15px 24px; font-size: 1rem; }

/* Autocomplete */
.autocomplete-wrapper { position: relative; }

.autocomplete-list {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid var(--primary);
    border-top: none;
    border-radius: 0 0 10px 10px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 50;
    display: none;
}

.autocomplete-list.active { display: block; }

.autocomplete-item {
    padding: 10px 12px;
    cursor: pointer;
}

.autocomplete-item:hover { background: var(--light); }

/* Trip List */
.trip-list { display: flex; flex-direction: column; gap: 10px; }

.trip-item {
    background: var(--light);
    border-radius: 12px;
    padding: 14px;
    border-left: 4px solid var(--primary);
}

.trip-item-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 6px;
}

.trip-item-route { font-weight: 600; font-size: 0.95rem; }
.trip-item-km {
    background: var(--primary);
    color: white;
    padding: 3px 10px;
    border-radius: 10px;
    font-size: 0.8rem;
    font-weight: 600;
}

.trip-item-meta {
    font-size: 0.8rem;
    color: var(--gray);
}

/* GPS Status */
.gps-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 15px;
}

.gps-status.loading { background: rgba(255, 152, 0, 0.1); color: var(--accent); }
.gps-status.success { background: rgba(76, 175, 80, 0.1); color: var(--success); }
.gps-status.error { background: rgba(244, 67, 54, 0.1); color: var(--danger); }

/* Toast */
.toast-container {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 2000;
}

.toast {
    background: var(--dark);
    color: white;
    padding: 12px 20px;
    border-radius: 10px;
    margin-top: 8px;
    animation: slideUp 0.3s ease;
}

.toast.success { background: var(--success); }
.toast.error { background: var(--danger); }

@keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--gray);
}

.empty-state i { font-size: 3rem; margin-bottom: 15px; opacity: 0.3; }
</style>
</head>
<body>

<!-- Auth Screen -->
<div class="auth-screen" id="auth-screen">
    <div class="auth-box">
        <h1><i class="fas fa-car"></i> KM Registratie Pro</h1>
        <p>Sluitende kilometerregistratie</p>
        
        <!-- Setup Mode (eerste keer) -->
        <div id="setup-mode" class="hidden">
            <div style="background: rgba(46,125,50,0.2); padding: 12px; border-radius: 10px; margin-bottom: 20px; color: var(--primary-light); font-size: 0.85rem;">
                <i class="fas fa-info-circle"></i> Eerste keer? Kies een naam en pincode.
            </div>
            <input type="text" id="setup-name" placeholder="Uw naam" autocomplete="name">
            <input type="password" id="setup-pin" placeholder="Kies pincode (4 cijfers)" maxlength="4" inputmode="numeric">
            <input type="password" id="setup-pin-confirm" placeholder="Bevestig pincode" maxlength="4" inputmode="numeric">
            <button onclick="Auth.setup()">
                <i class="fas fa-check"></i> Account aanmaken
            </button>
            <div class="auth-error" id="setup-error"></div>
        </div>
        
        <!-- Login Mode -->
        <div id="login-mode" class="hidden">
            <input type="text" id="login-name" placeholder="Uw naam" autocomplete="name">
            <input type="password" id="login-pin" placeholder="Pincode" maxlength="4" inputmode="numeric">
            <button onclick="Auth.login()">
                <i class="fas fa-sign-in-alt"></i> Inloggen
            </button>
            <div class="auth-error" id="login-error"></div>
        </div>
        
        <p style="margin-top: 20px; font-size: 0.75rem; color: var(--gray);">
            © 2025 Knowledge by Data
        </p>
    </div>
</div>

<!-- App Container -->
<div class="app-container" id="app-container">
    <div class="security-bar">
        <i class="fas fa-lock"></i> KM Registratie - Data blijft lokaal
    </div>

    <header class="app-header">
        <h1><i class="fas fa-car"></i> KM Registratie Pro</h1>
        <p class="user-name">Medewerker: <span id="display-user-name">-</span></p>
    </header>

    <nav class="nav-tabs">
        <button class="nav-tab active" data-tab="dashboard">
            <i class="fas fa-home"></i> Dashboard
        </button>
        <button class="nav-tab" data-tab="trip">
            <i class="fas fa-route"></i> Rit
        </button>
        <button class="nav-tab" data-tab="overview">
            <i class="fas fa-list"></i> Overzicht
        </button>
        <button class="nav-tab" data-tab="export">
            <i class="fas fa-download"></i> Export
        </button>
    </nav>

    <main class="main-content">
        <!-- Dashboard -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="stat-trips">0</div>
                    <div class="stat-label">Ritten</div>
                </div>
                <div class="stat-card accent">
                    <div class="stat-number" id="stat-km">0</div>
                    <div class="stat-label">Kilometers</div>
                </div>
                <div class="stat-card neutral">
                    <div class="stat-number" id="stat-month-km">0</div>
                    <div class="stat-label">Deze maand</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-current-odo">0</div>
                    <div class="stat-label">Huidige stand</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title"><i class="fas fa-history"></i> Laatste ritten</span>
                </div>
                <div id="recent-trips" class="trip-list"></div>
            </div>

            <button class="btn btn-primary btn-block btn-lg" onclick="switchTab('trip')">
                <i class="fas fa-plus"></i> Nieuwe Rit
            </button>
        </div>

        <!-- Trip Tab -->
        <div id="tab-trip" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><i class="fas fa-route"></i> Rit Registreren</span>
                </div>

                <div class="gps-status" id="gps-status">
                    <i class="fas fa-satellite"></i>
                    <span>GPS gereed</span>
                </div>

                <div class="form-group">
                    <label class="form-label">Datum</label>
                    <input type="date" id="trip-date" class="form-control">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Beginstand (km)</label>
                        <input type="number" id="trip-start-km" class="form-control" placeholder="12345">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Eindstand (km)</label>
                        <input type="number" id="trip-end-km" class="form-control" placeholder="12400">
                    </div>
                </div>

                <div class="form-group autocomplete-wrapper">
                    <label class="form-label">Van (plaats)</label>
                    <input type="text" id="trip-from" class="form-control" placeholder="Vertrekplaats" autocomplete="off">
                    <div class="autocomplete-list" id="autocomplete-from"></div>
                </div>

                <div class="form-group autocomplete-wrapper">
                    <label class="form-label">Naar (plaats)</label>
                    <input type="text" id="trip-to" class="form-control" placeholder="Bestemming" autocomplete="off">
                    <div class="autocomplete-list" id="autocomplete-to"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Doel van de rit</label>
                    <input type="text" id="trip-purpose" class="form-control" placeholder="Bijv. Klantbezoek">
                </div>

                <button class="btn btn-primary btn-block btn-lg" onclick="saveTrip()">
                    <i class="fas fa-save"></i> Rit Opslaan
                </button>
                
                <button class="btn btn-outline btn-block" onclick="captureGPS()" style="margin-top: 10px;">
                    <i class="fas fa-location-crosshairs"></i> GPS Vastleggen
                </button>
            </div>
        </div>

        <!-- Overview Tab -->
        <div id="tab-overview" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><i class="fas fa-list"></i> Alle Ritten</span>
                    <span id="trip-count">0</span>
                </div>
                <div id="all-trips" class="trip-list"></div>
            </div>
        </div>

        <!-- Export Tab -->
        <div id="tab-export" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><i class="fas fa-download"></i> Exporteren</span>
                </div>
                <p style="color: var(--gray); margin-bottom: 20px; font-size: 0.9rem;">
                    Exporteer alle ritten als JSON bestand voor Knowledge by Data administratie.
                </p>
                
                <button class="btn btn-primary btn-block btn-lg" onclick="exportJSON()">
                    <i class="fas fa-file-code"></i> Exporteer JSON
                </button>

                <button class="btn btn-outline btn-block" onclick="exportCSV()" style="margin-top: 10px;">
                    <i class="fas fa-file-csv"></i> Exporteer CSV
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title"><i class="fas fa-user"></i> Sessie</span>
                </div>
                <button class="btn btn-danger btn-block" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Uitloggen
                </button>
            </div>
        </div>
    </main>
</div>

<div class="toast-container" id="toast-container"></div>

<script>
'use strict';

// Auth Module - Zelfgekozen naam en pincode
const Auth = {
    STORAGE_KEY: 'km_auth',
    
    init() {
        const saved = localStorage.getItem(this.STORAGE_KEY);
        if (saved) {
            document.getElementById('setup-mode').classList.add('hidden');
            document.getElementById('login-mode').classList.remove('hidden');
            document.getElementById('login-pin').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') this.login();
            });
        } else {
            document.getElementById('setup-mode').classList.remove('hidden');
            document.getElementById('login-mode').classList.add('hidden');
            document.getElementById('setup-pin-confirm').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') this.setup();
            });
        }
    },
    
    setup() {
        const name = document.getElementById('setup-name').value.trim();
        const pin = document.getElementById('setup-pin').value;
        const pinConfirm = document.getElementById('setup-pin-confirm').value;
        const errorEl = document.getElementById('setup-error');
        
        if (!name) { errorEl.textContent = 'Voer uw naam in'; return; }
        if (!/^\d{4}$/.test(pin)) { errorEl.textContent = 'Pincode moet 4 cijfers zijn'; return; }
        if (pin !== pinConfirm) { errorEl.textContent = 'Pincodes komen niet overeen'; return; }
        
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify({ name, pin }));
        APP_STATE.user = name;
        loadData();
        showApp();
    },
    
    login() {
        const name = document.getElementById('login-name').value.trim();
        const pin = document.getElementById('login-pin').value;
        const errorEl = document.getElementById('login-error');
        const saved = JSON.parse(localStorage.getItem(this.STORAGE_KEY));
        
        if (!name || !pin) { errorEl.textContent = 'Vul naam en pincode in'; return; }
        if (name === saved.name && pin === saved.pin) {
            APP_STATE.user = name;
            loadData();
            showApp();
        } else {
            errorEl.textContent = 'Ongeldige naam of pincode';
            document.getElementById('login-pin').value = '';
        }
    },
    
    logout() {
        if (!confirm('Weet u zeker dat u wilt uitloggen?')) return;
        location.reload();
    },
    
    getCurrentUser() {
        return APP_STATE.user;
    }
};

const DUTCH_PLACES = [
    'Aalsmeer','Aalten','Achtkarspelen','Alblasserdam','Albrandswaard','Alkmaar','Almelo','Almere',
    'Alphen aan den Rijn','Amersfoort','Amstelveen','Amsterdam','Apeldoorn','Arnhem','Assen',
    'Asten','Baarle-Nassau','Baarn','Barendrecht','Barneveld','Beek','Beekdaelen','Beesel',
    'Berg en Dal','Bergeijk','Bergen (L)','Bergen (NH)','Bergen op Zoom','Berkelland','Bernheze',
    'Best','Beuningen','Beverwijk','Bladel','Blaricum','Bloemendaal','Bodegraven-Reeuwijk',
    'Boekel','Borger-Odoorn','Borne','Borsele','Boxmeer','Boxtel','Breda','Brielle','Bronckhorst',
    'Brummen','Brunssum','Bunnik','Bunschoten','Buren','Capelle aan den IJssel','Castricum',
    'Coevorden','Cranendonck','Cuijk','Culemborg','Dalfsen','Dantumadiel','De Bilt','De Fryske Marren',
    'De Ronde Venen','De Wolden','Delft','Den Haag','Den Helder','Deurne','Deventer','Diemen',
    'Dinkelland','Doesburg','Doetinchem','Dongen','Dordrecht','Drechterland','Drimmelen','Dronten',
    'Druten','Duiven','Echt-Susteren','Edam-Volendam','Ede','Eemnes','Eersel','Eijsden-Margraten',
    'Eindhoven','Elburg','Emmen','Enkhuizen','Enschede','Epe','Ermelo','Etten-Leur','Geertruidenberg',
    'Geldrop-Mierlo','Gemert-Bakel','Gennep','Gilze en Rijen','Goeree-Overflakkee','Goes','Goirle',
    'Gooise Meren','Gorinchem','Gouda','Grave','Groningen','Gulpen-Wittem','Haaksbergen','Haarlem',
    'Haarlemmermeer','Halderberge','Hardenberg','Harderwijk','Hardinxveld-Giessendam','Harlingen',
    'Hattem','Heemskerk','Heemstede','Heerde','Heerenveen','Heerlen','Heeze-Leende','Heiloo',
    'Hellendoorn','Hellevoetsluis','Helmond','Hendrik-Ido-Ambacht','Hengelo','Het Hogeland',
    'Heumen','Heusden','Hillegom','Hilvarenbeek','Hilversum','Hoeksche Waard','Hof van Twente',
    'Hollands Kroon','Hoogeveen','Hoorn','Horst aan de Maas','Houten','Huizen','Hulst','IJsselstein',
    'Kaag en Braassem','Kampen','Kapelle','Katwijk','Kerkrade','Koggenland','Krimpen aan den IJssel',
    'Krimpenerwaard','Laarbeek','Landerd','Landgraaf','Landsmeer','Langedijk','Lansingerland',
    'Laren','Leeuwarden','Leiden','Leiderdorp','Leidschendam-Voorburg','Lelystad','Leudal',
    'Leusden','Lingewaard','Lisse','Lochem','Loon op Zand','Lopik','Losser','Maasdriel','Maasgouw',
    'Maassluis','Maastricht','Medemblik','Meerssen','Meierijstad','Meppel','Middelburg','Midden-Delfland',
    'Midden-Drenthe','Midden-Groningen','Mill en Sint Hubert','Moerdijk','Molenlanden','Montferland',
    'Montfoort','Mook en Middelaar','Neder-Betuwe','Nederweert','Nieuwegein','Nieuwkoop','Nijkerk',
    'Nijmegen','Nissewaard','Noardeast-Fryslân','Noord-Beveland','Noordenveld','Noordoostpolder',
    'Noordwijk','Nuenen','Nunspeet','Oegstgeest','Oirschot','Oisterwijk','Oldambt','Oldebroek',
    'Oldenzaal','Olst-Wijhe','Ommen','Oosterhout','Ooststellingwerf','Oostzaan','Opmeer','Opsterland',
    'Oss','Oude IJsselstreek','Ouder-Amstel','Oudewater','Overbetuwe','Papendrecht','Peel en Maas',
    'Pekela','Pijnacker-Nootdorp','Purmerend','Putten','Raalte','Reimerswaal','Renkum','Renswoude',
    'Reusel-De Mierden','Rheden','Rhenen','Ridderkerk','Rijssen-Holten','Rijswijk','Roerdalen',
    'Roermond','Roosendaal','Rotterdam','Rozendaal','Rucphen','Schagen','Scherpenzeel','Schiedam',
    'Schiermonnikoog','Schouwen-Duiveland','Simpelveld','Sint-Michielsgestel','Sittard-Geleen',
    'Sliedrecht','Sluis','Smallingerland','Soest','Someren','Son en Breugel','Stadskanaal',
    'Staphorst','Stede Broec','Steenbergen','Steenwijkerland','Stein','Stichtse Vecht','Súdwest-Fryslân',
    'Terneuzen','Terschelling','Texel','Teylingen','Tholen','Tiel','Tilburg','Tubbergen','Twenterand',
    'Tynaarlo','Tytsjerksteradiel','Uden','Uitgeest','Uithoorn','Urk','Utrecht','Utrechtse Heuvelrug',
    'Vaals','Valkenburg aan de Geul','Valkenswaard','Veendam','Veenendaal','Veere','Veldhoven',
    'Velsen','Venlo','Venray','Vijfheerenlanden','Vlaardingen','Vlieland','Vlissingen','Voerendaal',
    'Voorschoten','Voorst','Vught','Waadhoeke','Waalre','Waalwijk','Waddinxveen','Wageningen',
    'Wassenaar','Waterland','Weert','Weesp','West Betuwe','West Maas en Waal','Westerkwartier',
    'Westerveld','Westervoort','Westland','Weststellingwerf','Westvoorne','Wierden','Wijchen',
    'Wijdemeren','Wijk bij Duurstede','Winterswijk','Woensdrecht','Woerden','Wormerland','Woudenberg',
    'Zaanstad','Zaltbommel','Zandvoort','Zeewolde','Zeist','Zevenaar','Zoetermeer','Zoeterwoude',
    'Zuidplas','Zundert','Zutphen','Zwartewaterland','Zwijndrecht','Zwolle'
];

const APP_STATE = {
    user: null,
    trips: [],
    currentGPS: null
};

function showApp() {
    document.getElementById('auth-screen').classList.add('hidden');
    document.getElementById('app-container').classList.add('active');
    document.getElementById('display-user-name').textContent = APP_STATE.user;
    updateUI();
}

function logout() {
    Auth.logout();
}
}

function checkSession() {
    Auth.init();
}

// Data
function loadData() {
    const data = localStorage.getItem('km_trips_' + APP_STATE.user);
    APP_STATE.trips = data ? JSON.parse(data) : [];
}

function saveData() {
    localStorage.setItem('km_trips_' + APP_STATE.user, JSON.stringify(APP_STATE.trips));
}

// Tabs
document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', () => switchTab(tab.dataset.tab));
});

function switchTab(tabId) {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tabId));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === 'tab-' + tabId));
    
    if (tabId === 'trip') {
        document.getElementById('trip-date').value = new Date().toISOString().split('T')[0];
        const lastTrip = APP_STATE.trips[0];
        if (lastTrip) {
            document.getElementById('trip-start-km').value = lastTrip.endKm;
        }
    }
}

// GPS
function captureGPS() {
    const statusEl = document.getElementById('gps-status');
    statusEl.className = 'gps-status loading';
    statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> GPS wordt bepaald...';
    
    if (!navigator.geolocation) {
        statusEl.className = 'gps-status error';
        statusEl.innerHTML = '<i class="fas fa-times-circle"></i> GPS niet beschikbaar';
        return;
    }
    
    navigator.geolocation.getCurrentPosition(
        (pos) => {
            APP_STATE.currentGPS = {
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                accuracy: pos.coords.accuracy,
                timestamp: new Date().toISOString()
            };
            statusEl.className = 'gps-status success';
            statusEl.innerHTML = `<i class="fas fa-check-circle"></i> GPS: ${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`;
        },
        (err) => {
            statusEl.className = 'gps-status error';
            statusEl.innerHTML = '<i class="fas fa-times-circle"></i> GPS fout: ' + err.message;
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
}

// Autocomplete
['from', 'to'].forEach(field => {
    const input = document.getElementById('trip-' + field);
    const list = document.getElementById('autocomplete-' + field);
    
    input.addEventListener('input', () => {
        const val = input.value.toLowerCase();
        if (val.length < 2) { list.classList.remove('active'); return; }
        
        const matches = DUTCH_PLACES.filter(p => p.toLowerCase().includes(val)).slice(0, 8);
        if (matches.length === 0) { list.classList.remove('active'); return; }
        
        list.innerHTML = matches.map(p => `<div class="autocomplete-item">${p}</div>`).join('');
        list.classList.add('active');
        
        list.querySelectorAll('.autocomplete-item').forEach(item => {
            item.addEventListener('click', () => {
                input.value = item.textContent;
                list.classList.remove('active');
            });
        });
    });
    
    input.addEventListener('blur', () => setTimeout(() => list.classList.remove('active'), 200));
});

// Save Trip
function saveTrip() {
    const date = document.getElementById('trip-date').value;
    const startKm = parseInt(document.getElementById('trip-start-km').value);
    const endKm = parseInt(document.getElementById('trip-end-km').value);
    const from = document.getElementById('trip-from').value.trim();
    const to = document.getElementById('trip-to').value.trim();
    const purpose = document.getElementById('trip-purpose').value.trim();
    
    if (!date || !startKm || !endKm || !from || !to) {
        showToast('Vul alle verplichte velden in', 'error');
        return;
    }
    
    if (endKm <= startKm) {
        showToast('Eindstand moet hoger zijn dan beginstand', 'error');
        return;
    }
    
    const trip = {
        id: Date.now().toString(36),
        date,
        startKm,
        endKm,
        distance: endKm - startKm,
        from,
        to,
        purpose,
        gps: APP_STATE.currentGPS,
        createdAt: new Date().toISOString()
    };
    
    APP_STATE.trips.unshift(trip);
    saveData();
    updateUI();
    
    // Reset form
    document.getElementById('trip-end-km').value = '';
    document.getElementById('trip-from').value = '';
    document.getElementById('trip-to').value = '';
    document.getElementById('trip-purpose').value = '';
    APP_STATE.currentGPS = null;
    document.getElementById('gps-status').className = 'gps-status';
    document.getElementById('gps-status').innerHTML = '<i class="fas fa-satellite"></i> GPS gereed';
    
    showToast(`${trip.distance} km geregistreerd`, 'success');
    switchTab('dashboard');
}

// UI Updates
function updateUI() {
    updateStats();
    updateRecentTrips();
    updateAllTrips();
}

function updateStats() {
    const totalKm = APP_STATE.trips.reduce((sum, t) => sum + t.distance, 0);
    const currentMonth = new Date().toISOString().slice(0, 7);
    const monthKm = APP_STATE.trips.filter(t => t.date.startsWith(currentMonth)).reduce((sum, t) => sum + t.distance, 0);
    const lastTrip = APP_STATE.trips[0];
    
    document.getElementById('stat-trips').textContent = APP_STATE.trips.length;
    document.getElementById('stat-km').textContent = totalKm;
    document.getElementById('stat-month-km').textContent = monthKm;
    document.getElementById('stat-current-odo').textContent = lastTrip ? lastTrip.endKm : 0;
}

function updateRecentTrips() {
    const container = document.getElementById('recent-trips');
    const recent = APP_STATE.trips.slice(0, 5);
    
    if (recent.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-car"></i><p>Nog geen ritten</p></div>';
        return;
    }
    
    container.innerHTML = recent.map(t => renderTrip(t)).join('');
}

function updateAllTrips() {
    const container = document.getElementById('all-trips');
    document.getElementById('trip-count').textContent = APP_STATE.trips.length;
    
    if (APP_STATE.trips.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-car"></i><p>Nog geen ritten</p></div>';
        return;
    }
    
    container.innerHTML = APP_STATE.trips.map(t => renderTrip(t)).join('');
}

function renderTrip(t) {
    const date = new Date(t.date).toLocaleDateString('nl-NL', { day: 'numeric', month: 'short' });
    return `
        <div class="trip-item">
            <div class="trip-item-header">
                <span class="trip-item-route">${escapeHtml(t.from)} → ${escapeHtml(t.to)}</span>
                <span class="trip-item-km">${t.distance} km</span>
            </div>
            <div class="trip-item-meta">
                <span><i class="fas fa-calendar"></i> ${date}</span>
                ${t.purpose ? ` | ${escapeHtml(t.purpose)}` : ''}
            </div>
        </div>
    `;
}

// Export
function exportJSON() {
    if (APP_STATE.trips.length === 0) {
        showToast('Geen data om te exporteren', 'error');
        return;
    }
    
    const exportData = {
        type: 'km_registratie',
        version: '2.0.0',
        medewerker: APP_STATE.user,
        exportDatum: new Date().toISOString(),
        periode: {
            van: APP_STATE.trips[APP_STATE.trips.length - 1].date,
            tot: APP_STATE.trips[0].date
        },
        totalen: {
            aantalRitten: APP_STATE.trips.length,
            totaalKilometers: APP_STATE.trips.reduce((sum, t) => sum + t.distance, 0)
        },
        ritten: APP_STATE.trips
    };
    
    const filename = `km_registratie_${APP_STATE.user.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
    downloadFile(JSON.stringify(exportData, null, 2), filename, 'application/json');
    showToast('JSON geëxporteerd', 'success');
}

function exportCSV() {
    if (APP_STATE.trips.length === 0) {
        showToast('Geen data om te exporteren', 'error');
        return;
    }
    
    const headers = ['Medewerker', 'Datum', 'Van', 'Naar', 'Beginstand', 'Eindstand', 'Afstand', 'Doel', 'GPS Lat', 'GPS Lng'];
    const rows = APP_STATE.trips.map(t => [
        APP_STATE.user,
        t.date,
        t.from,
        t.to,
        t.startKm,
        t.endKm,
        t.distance,
        t.purpose || '',
        t.gps ? t.gps.lat : '',
        t.gps ? t.gps.lng : ''
    ]);
    
    const csv = [headers, ...rows].map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(';')).join('\n');
    const filename = `km_registratie_${APP_STATE.user.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
    downloadFile('\uFEFF' + csv, filename, 'text/csv;charset=utf-8');
    showToast('CSV geëxporteerd', 'success');
}

// Utils
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function downloadFile(content, filename, type) {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast ' + type;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Init
document.addEventListener('DOMContentLoaded', checkSession);

// Service Worker
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(err => console.error('SW:', err));
}
</script>
</body>
</html>
